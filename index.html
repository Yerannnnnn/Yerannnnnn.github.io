<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.2.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/web/favicon/fulan-apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/web/favicon/fulan-favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/web/favicon/fulan-favicon-16x16.png"><link rel="mask-icon" href="/images/web/favicon/fulan-safari-pinned-tab.svg" color="#222"><meta name="google-site-verification" content="QFS_u_GWmr82u0hid-IEXe4tHKtR2xqNYBOM1ls7Ck8"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css"><link rel="stylesheet" href="/lib/@fancyapps/fancybox/dist/jquery.fancybox.min.css"><script class="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"yuanjiuzheng.com",root:"/",scheme:"Gemini",version:"8.0.2",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12},copycode:!0,bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!0,pangu:!1,comments:{style:"tabs",active:"gitalk",storage:!1,lazyload:!0,nav:null,activeClass:"gitalk"},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"fadeInDown",post_body:"fadeInDown",coll_header:"fadeInLeft",sidebar:"fadeInUp"}},prism:!1,i18n:{placeholder:"搜索...",empty:"没有找到任何搜索结果：${query}",hits_time:"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）",hits:"找到 ${hits} 个搜索结果"},path:"/search.xml",localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1}}</script><meta name="description" content="一直折腾一直爽"><meta property="og:type" content="website"><meta property="og:title" content="Yeran"><meta property="og:url" content="https://yuanjiuzheng.com/index.html"><meta property="og:site_name" content="Yeran"><meta property="og:description" content="一直折腾一直爽"><meta property="og:locale" content="zh_CN"><meta property="article:author" content="Nemo.yeran"><meta property="article:tag" content="Nemo"><meta property="article:tag" content="Yerannnnnn"><meta property="article:tag" content="博客"><meta property="article:tag" content="blog"><meta property="article:tag" content="Nemo.yeran"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://yuanjiuzheng.com/"><script data-pjax class="page-configurations">CONFIG.page={sidebar:"",isHome:!0,isPost:!1,lang:"zh-CN"}</script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"><link rel="stylesheet" type="text/css" href="/live2d_widget/ny.waifu-load.css"><script src="//cdn.jsdelivr.net/gh/Yerannnnnn/Yerannnnnn.github.io@master/live2d_widget/ny.waifu.js" id="nywaifujs"></script><script src="/live2d_widget/ny.waifu-load.js" id="ny_waifu_load_js"></script><title>Yeran - 不忘初心</title><noscript><style>body{margin-top:2rem}.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header,.use-motion .sidebar{visibility:visible}.use-motion .footer,.use-motion .header,.use-motion .site-brand-container .toggle{opacity:initial}.use-motion .custom-logo-image,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line{transform:scaleX(1)}.search-pop-overlay,.sidebar-nav{display:none}.sidebar-panel{display:block}</style></noscript><link rel="alternate" href="/atom.xml" title="Yeran" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><h1 class="site-title">Yeran</h1><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">不忘初心</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i> 首页</a></li><li class="menu-item menu-item-playground"><a href="/pages/playground/" rel="section"><i class="fa fa-grin-tongue fa-fw"></i> 玩具</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i> 归档</a></li><li class="menu-item menu-item-tags"><a href="/pages/tags/" rel="section"><i class="fa fa-tags fa-fw"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/pages/categories/" rel="section"><i class="fa fa-th fa-fw"></i> 分类</a></li><li class="menu-item menu-item-about"><a href="/pages/about/" rel="section"><i class="fa fa-user fa-fw"></i> 关于</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-overview-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><section class="post-toc-wrap sidebar-panel"></section><section class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Nemo.yeran" src="/images/web/avatar-nemo3.jpg"><p class="site-author-name" itemprop="name">Nemo.yeran</p><div class="site-description" itemprop="description">一直折腾一直爽</div></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">8</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/pages/categories/"><span class="site-state-item-count">4</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/pages/tags/"><span class="site-state-item-count">14</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author site-overview-item animated"><span class="links-of-author-item"><a href="https://github.com/yerannnnnn" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;yerannnnnn" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="https://space.bilibili.com/670716" title="BiliBili → https:&#x2F;&#x2F;space.bilibili.com&#x2F;670716" rel="noopener" target="_blank"><i class="fa fa-tv fa-fw"></i> BiliBili</a></span><span class="links-of-author-item"><a href="mailto:yuanjiuzheng@foxmail.com" title="E-Mail → mailto:yuanjiuzheng@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i> RSS</a></span></div><div class="cc-license site-overview-item animated" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a></div><div class="links-of-blogroll site-overview-item animated"><div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="https://yuanjiuzheng.com/" title="https:&#x2F;&#x2F;yuanjiuzheng.com">Ê×Ò³</a></li></ul></div></section></div><div class="back-to-top animated"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div></aside><div class="sidebar-dimmer"></div></header><div class="reading-progress-bar"></div> <a href="https://github.com/yerannnnnn" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner index posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://yuanjiuzheng.com/blog/dp003/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/web/avatar-nemo3.jpg"><meta itemprop="name" content="Nemo.yeran"><meta itemprop="description" content="一直折腾一直爽"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Yeran"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/blog/dp003/" class="post-title-link" itemprop="url">【设计模式之美】面向对象、设计原则、设计模式、编程规范、重构</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-06-19 19:57:06" itemprop="dateCreated datePublished" datetime="2020-06-19T19:57:06+08:00">2020-06-19</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%BE%8E/" itemprop="url" rel="index"><span itemprop="name">设计模式之美</span></a></span></span></div><div class="post-meta"><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>12k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>11 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>王争《设计模式之美》学习笔记</p></blockquote><h2 id="面向对象"><a href="#面向对象" class="headerlink" title="面向对象"></a>面向对象</h2><h3 id="面向对象概述"><a href="#面向对象概述" class="headerlink" title="面向对象概述"></a>面向对象概述</h3><p>现在，主流的编程范式或者编程风格有三种，它们分别是面向过程、面向对象和函数式编程。面向对象这种编程风格又是这其中最主流的。现在比较流行的编程语言大部分都是面向对象编程语言。大部分项目也都是基于面向对象编程风格开发的。面向对象编程因为其具有丰富的特性（封装、抽象、继承、多态），可以实现很多复杂的设计思路，是很多设计原则、设计模式编码实现的基础。</p><h3 id="面向对象四大特性概述"><a href="#面向对象四大特性概述" class="headerlink" title="面向对象四大特性概述"></a>面向对象四大特性概述</h3><p>封装也叫作信息隐藏或者数据访问保护。类通过暴露有限的访问接口，授权外部仅能通过类提供的方法来访问内部信息或者数据。它需要编程语言提供权限访问控制语法来支持，例如 Java 中的 private、protected、public 关键字。封装特性存在的意义，一方面是保护数据不被随意修改，提高代码的可维护性；另一方面是仅暴露有限的必要接口，提高类的易用性。</p><p>如果说封装主要讲如何隐藏信息、保护数据，那抽象就是讲如何隐藏方法的具体实现，让使用者只需要关心方法提供了哪些功能，不需要知道这些功能是如何实现的。抽象可以通过接口类或者抽象类来实现。抽象存在的意义，一方面是修改实现不需要改变定义；另一方面，它也是处理复杂系统的有效手段，能有效地过滤掉不必要关注的信息。</p><p>继承用来表示类之间的 is-a 关系，分为两种模式：单继承和多继承。单继承表示一个子类只继承一个父类，多继承表示一个子类可以继承多个父类。为了实现继承这个特性，编程语言需要提供特殊的语法机制来支持。继承主要是用来解决代码复用的问题。</p><p>多态是指子类可以替换父类，在实际的代码运行过程中，调用子类的方法实现。多态这种特性也需要编程语言提供特殊的语法机制来实现，比如继承、接口类、duck-typing。多态可以提高代码的扩展性和复用性，是很多设计模式、设计原则、编程技巧的代码实现基础。</p><div class="post-button"> <a class="btn" href="/blog/dp003/#more" rel="contents">阅读全文 &raquo;</a></div></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://yuanjiuzheng.com/blog/dp002/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/web/avatar-nemo3.jpg"><meta itemprop="name" content="Nemo.yeran"><meta itemprop="description" content="一直折腾一直爽"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Yeran"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/blog/dp002/" class="post-title-link" itemprop="url">【设计模式之美】如何评价代码的好坏</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-06-15 18:57:06" itemprop="dateCreated datePublished" datetime="2020-06-15T18:57:06+08:00">2020-06-15</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%BE%8E/" itemprop="url" rel="index"><span itemprop="name">设计模式之美</span></a></span></span></div><div class="post-meta"><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>4.7k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>4 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>王争《设计模式之美》学习笔记</p></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>代码质量的评价有很强的主观性，描述代码质量的词汇也有很多，比如可读性、可维护性、灵活、优雅、简洁。这些词汇是从不同的维度去评价代码质量的。它们之间有互相作用，并不是独立的，比如，代码的可读性好、可扩展性好就意味着代码的可维护性好。代码质量高低是一个综合各种因素得到的结论。并不能通过单一维度去评价一段代码的好坏。</p><p>最常用到几个评判代码质量的标准有：可维护性、可读性、可扩展性、灵活性、简洁性、可复用性、可测试性。其中，可维护性、可读性、可扩展性又是提到最多的、最重要的三个评价标准。</p><div class="post-button"> <a class="btn" href="/blog/dp002/#more" rel="contents">阅读全文 &raquo;</a></div></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://yuanjiuzheng.com/blog/dp001/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/web/avatar-nemo3.jpg"><meta itemprop="name" content="Nemo.yeran"><meta itemprop="description" content="一直折腾一直爽"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Yeran"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/blog/dp001/" class="post-title-link" itemprop="url">【设计模式之美】开篇</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-06-09 17:57:06" itemprop="dateCreated datePublished" datetime="2020-06-09T17:57:06+08:00">2020-06-09</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%BE%8E/" itemprop="url" rel="index"><span itemprop="name">设计模式之美</span></a></span></span></div><div class="post-meta"><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>2.6k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>2 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>王争《设计模式之美》学习笔记</p></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>夯实基础，才能走得更远。之前看了很多基础知识的书籍，比如操作系统、组成原理、编译原理等。实际上，这些基础的知识确实很难直接转化成开发“生产力”，但能潜移默化地、间接地提高对技术的理解。</p><p>最近觉得很有必要把设计模式重新抓一抓，设计模式和操作系统、组成原理、编译原理等这些基础学科是不一样的。它虽然也算是一门基础知识，但是它和数据结构、算法更像是一道儿的，相比那些更加基础的学科，设计模式能更直接地提高开发能力。如果说数据结构和算法是讨论如何写出高效代码，那设计模式就是讨论如何写出可扩展、可读、可维护的高质量代码，所以，它们跟平时的编码会有直接的关系，也会一定程度上直接影响开发能力。</p><h2 id="不要写被人吐槽的烂代码"><a href="#不要写被人吐槽的烂代码" class="headerlink" title="不要写被人吐槽的烂代码"></a>不要写被人吐槽的烂代码</h2><p>经常有人说，“Talk is cheap，show me the code。”</p><p>实际上，代码能力是一个程序员最基础的能力，是基本功，是展示一个程序员基础素养的最直接的衡量标准。程序员所写的代码，实际上就是程序员最直接的名片。</p><div class="post-button"> <a class="btn" href="/blog/dp001/#more" rel="contents">阅读全文 &raquo;</a></div></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://yuanjiuzheng.com/blog/cc03/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/web/avatar-nemo3.jpg"><meta itemprop="name" content="Nemo.yeran"><meta itemprop="description" content="一直折腾一直爽"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Yeran"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/blog/cc03/" class="post-title-link" itemprop="url">【折腾笔记】看板娘浏览器</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-05-30 17:57:06" itemprop="dateCreated datePublished" datetime="2020-05-30T17:57:06+08:00">2020-05-30</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E6%8A%98%E8%85%BE%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">折腾笔记</span></a></span></span></div><div class="post-meta"><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>810</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>1 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1> <a href="/ny/waifuViewer/" style="text-decoration:none!important"><button class="nybtn nybtn_link" onclick=""><span onclick="">waifuViewer</span></button></a><br><br><br><p>从<a target="_blank" rel="noopener" href="https://github.com/Eikanya/Live2d-model">Live2d-model</a>弄了好多模型下来，但是没法看，于是就折腾了个waifuViewer~</p><hr><p>这几天沉迷个人主页，搞了四五天，emm，虽然自己这几篇文章都打了“不务正业”的标签，但这波也算是开拓视野了。以前从未接触js/css/html开发相关的东西，这算是在自己不熟悉的领域去实现自己的需求，虽然<strong>东西很简单</strong>，但坑处处都是，总的来说挺考验自己的，也从侧面证实了一直以来坚信的一个观点:</p><blockquote><p>重要的不是知识，而是对知识的应用和理解，以及快速查找知识的能力</p><p>重要的不是题解，而是解题的思路和方法，甚至风格、态度、执拗</p></blockquote><p>当然，<strong>认知</strong>（或者说经验+知识）也很重要。计算机世界的发展除了不断迸发的idea和design，也经历了无数的参考与借鉴，所以很多东西自然而然有<strong>相通</strong>的地方，在遇到新问题的时候，认知面会为解决问题提供支撑。</p><p>这段时间虽然”不务正业”，但对博导（前公司老板）的教诲有了新的认识，<strong>WHY-WHAT-HOW</strong>里面，虽然小规模的问题都体现在HOW上，但其实最不重要的就是HOW。计算机中也存在<strong>道法术</strong>。道，是规则、自然法则，上乘；法，是方法、法理，中乘；术，是行为、方式，下乘。以道御术，悟道比修炼法术更高一筹。但要做到这一点，还需要<strong>不断的努力</strong>，道法术三者兼备才能做出最好的策略。</p><p>个人主页先放放，要玩玩别的了！</p><hr><h1 id="踩坑小计"><a href="#踩坑小计" class="headerlink" title="踩坑小计"></a>踩坑小计</h1><table><thead><tr><th>ISSUE</th><th>FIXED</th></tr></thead><tbody><tr><td>✔ 布局异常</td><td>BOX+CSS解决</td></tr><tr><td>✔ 手机显示异常</td><td>CSS多设备适配</td></tr><tr><td>✔ 和左下角看板娘冲突</td><td>进入页面主动隐藏左下角看板娘</td></tr><tr><td>✔ 跳转会刷新整个页面</td><td>使用pjax</td></tr><tr><td>✔ pjax跳转但不加载js</td><td>对需要加载的js做pjax-data标记</td></tr><tr><td>✔ 按钮超链接有下划线</td><td>css增加nybtn_link 追加处理</td></tr><tr><td>✔ pjax重复加载js报错</td><td>优化js</td></tr></tbody></table><p>后面还有todo的话 大概有以下几个方面</p><ol><li>支持多个live2d同时显示（纸片人老婆+1+1+1 ???</li><li>按钮列表换种方式布局，以便随意添加按钮</li><li>子页面用scrollbar控制来显示按钮</li></ol></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://yuanjiuzheng.com/blog/cc04/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/web/avatar-nemo3.jpg"><meta itemprop="name" content="Nemo.yeran"><meta itemprop="description" content="一直折腾一直爽"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Yeran"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/blog/cc04/" class="post-title-link" itemprop="url">【C++】宏编程艺术（一）初探</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-05-30 17:57:06" itemprop="dateCreated datePublished" datetime="2020-05-30T17:57:06+08:00">2020-05-30</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C++</span></a></span></span></div><div class="post-meta"><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>27k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>24 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><h2 id="技术选型"><a href="#技术选型" class="headerlink" title="技术选型"></a>技术选型</h2><p>“对于任何事物，代码中只应该出现一次，而且是唯一的一次。 如果你在repeat，要么是在偷懒，要么是在犯错”——鲁迅</p><p>在写业务代码的时候，及时基础设施已经足够优秀，但仍然不可避免要写很多重复代码，于是研究了一下C++中消除重复的某些手段：如模板元编程、宏编程(预处理元编程)。</p><p>其中模板元编程这个屠龙之技有部分局限性：</p><ol><li>不能通过 模板展开 生成新的 标识符（例如 生成新的 函数名、类名、名字空间名 等）</li><li>使用者 只能使用 预先定义的标识符(否则不识别标识符编译不通过 unknow symbol xxx)</li><li>不能通过 模板参数 获取名称的字面量，使用者只能通过传递字符串参数绕开限制 (宏编程中可以使用#获取字面量)</li><li>受C++标准及编译器版本限制</li></ol><p>在探究宏编程邪教时，发现宏编程十分适用于我锁遇到的痛点问题，而且这次引发需求的场景更需要批量生成标识符，选择了使用宏编程技术解决该痛点。</p><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>在启动这次研究之前，对于宏编程的认识还停留在”简单的文本替换而已”,对于预处理只经常接触以下几种基本简单应用：</p><ol><li>头文件保护</li><li>适配平台</li><li>选择性编译</li><li>小公共代码块替换</li><li>单元测试hack-mock</li></ol><p>平时开发最经常接触的就是小代码块了，常见的比如</p><table><thead><tr><th>例子</th><th>代码</th></tr></thead><tbody><tr><td>使用宏拼接命名</td><td><code>#define CONCAT_NAME(a, b) a##b</code></td></tr><tr><td>使用宏将名称转为字符串</td><td><code>#define CONCAT(a, b) a##b</code></td></tr><tr><td>重复代码抽离</td><td><code>#define DO_SOME_THING() do&#123;balabala;&#125;while(0)</code></td></tr><tr><td>C-STYLE日志</td><td><code>#define log_debug(...) log(&quot;debug&quot; ,__function__ , __LINE__, __VA_ARGS__)</code></td></tr></tbody></table><p>这次研究引入了以下几个核心知识点</p><ol><li>预处理三阶段（预扫描、扫描、替换）</li><li>参数何时展开 展开何时终止</li><li>宏的延迟展开与提前展开手段</li><li>宏数据结构 （元组 序列 列表）</li><li>Clang、MSVC、GCC各编译器宏处理的差异(跨平台坑)</li></ol><p>由这些知识点、可以获取以下宏编程基本手法</p><ol><li>惰性求值、延迟调用、延迟展开</li><li>逻辑运算、布尔转换、条件选择</li><li>长度判空、长度计算、下标访问</li><li>借助以上N点原理，获取解决痛点的利器：宏遍历</li></ol><h1 id="需求场景"><a href="#需求场景" class="headerlink" title="需求场景"></a>需求场景</h1><p>当前每次版本迭代需要对接后台实现新feature，于是要写大量类似代码，这里虚构一些代码说明几个明显的痛点。</p><h2 id="痛点代码示例"><a href="#痛点代码示例" class="headerlink" title="痛点代码示例"></a>痛点代码示例</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NemoAppRoom</span> :</span> <span class="keyword">public</span> NemoApiRoute</span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 声明api  每个api单独方法处理</span></span><br><span class="line">    <span class="comment">// API多的时候 声明搞的很多 类看着很庞大 无形增加维护人员的心理压力</span></span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">api0</span><span class="params">(<span class="keyword">const</span> <span class="built_in">string</span>&amp; api, <span class="keyword">const</span> <span class="built_in">string</span>&amp; params)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">api1</span><span class="params">(<span class="keyword">const</span> <span class="built_in">string</span>&amp; api, <span class="keyword">const</span> <span class="built_in">string</span>&amp; params)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">api2</span><span class="params">(<span class="keyword">const</span> <span class="built_in">string</span>&amp; api, <span class="keyword">const</span> <span class="built_in">string</span>&amp; params)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">api3</span><span class="params">(<span class="keyword">const</span> <span class="built_in">string</span>&amp; api, <span class="keyword">const</span> <span class="built_in">string</span>&amp; params)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">api4</span><span class="params">(<span class="keyword">const</span> <span class="built_in">string</span>&amp; api, <span class="keyword">const</span> <span class="built_in">string</span>&amp; params)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">api5</span><span class="params">(<span class="keyword">const</span> <span class="built_in">string</span>&amp; api, <span class="keyword">const</span> <span class="built_in">string</span>&amp; params, <span class="keyword">bool</span> bCallback)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">api6</span><span class="params">(<span class="keyword">const</span> <span class="built_in">string</span>&amp; api, <span class="keyword">const</span> <span class="built_in">string</span>&amp; params, <span class="keyword">bool</span> bCallback)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">api7</span><span class="params">(<span class="keyword">const</span> <span class="built_in">string</span>&amp; api, <span class="keyword">const</span> <span class="built_in">string</span>&amp; params)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">api8</span><span class="params">(<span class="keyword">const</span> <span class="built_in">string</span>&amp; api, <span class="keyword">const</span> <span class="built_in">string</span>&amp; params, <span class="keyword">bool</span> bCallback, <span class="keyword">bool</span> bFromNotify, Poco::VariantMap param)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">api9</span><span class="params">(<span class="keyword">const</span> <span class="built_in">string</span>&amp; api, <span class="keyword">const</span> <span class="built_in">string</span>&amp; params)</span></span>;</span><br><span class="line">    <span class="comment">// 注册api</span></span><br><span class="line">    RegisterRouterFunctions()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//  API绑定方法 （bind到眼花,增删API时极易出错）</span></span><br><span class="line">        RegisterRouterFunction(NEMO_API_LIVE_API0, <span class="built_in">std</span>::bind(&amp;NemoAppLive::api0, <span class="keyword">this</span>, _1, _2));</span><br><span class="line">        RegisterRouterFunction(NEMO_API_LIVE_API1, <span class="built_in">std</span>::bind(&amp;NemoAppLive::api1, <span class="keyword">this</span>, _1, _2));</span><br><span class="line">        RegisterRouterFunction(NEMO_API_LIVE_API2, <span class="built_in">std</span>::bind(&amp;NemoAppLive::api2, <span class="keyword">this</span>, _1, _2));</span><br><span class="line">        RegisterRouterFunction(NEMO_API_LIVE_API3, <span class="built_in">std</span>::bind(&amp;NemoAppLive::api3, <span class="keyword">this</span>, _1, _2));</span><br><span class="line">        <span class="comment">//RegisterRouterFunction(NEMO_API_LIVE_API4, std::bind(&amp;NemoAppLive::api4, this, _1, _2));</span></span><br><span class="line">        RegisterRouterFunction(NEMO_API_LIVE_API5, <span class="built_in">std</span>::bind(&amp;NemoAppLive::api5, <span class="keyword">this</span>, _1, _2));</span><br><span class="line">        RegisterRouterFunction(NEMO_API_LIVE_API6, <span class="built_in">std</span>::bind(&amp;NemoAppLive::api6, <span class="keyword">this</span>, _1, _2));</span><br><span class="line">        <span class="comment">// 有的类型不一致 更改时更需要谨慎</span></span><br><span class="line">        RegisterRouterFunction(NEMO_API_LIVE_API7, <span class="built_in">std</span>::bind(&amp;NemoAppLive::api7, <span class="keyword">this</span>, _1, _2, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>));</span><br><span class="line">        RegisterRouterFunction(NEMO_API_LIVE_API8, <span class="built_in">std</span>::bind(&amp;NemoAppLive::api8, <span class="keyword">this</span>, _1, _2, <span class="literal">true</span>));</span><br><span class="line">        RegisterRouterFunction(NEMO_API_LIVE_API9, <span class="built_in">std</span>::bind(&amp;NemoAppLive::api9, <span class="keyword">this</span>, _1, _2));</span><br><span class="line">        RegisterRouterFunction(NEMO_API_LIVE_API10, <span class="built_in">std</span>::bind(&amp;NemoAppLive::api10, <span class="keyword">this</span>, _1, _2, <span class="literal">true</span>, <span class="literal">false</span>, Poco::VariantMap()));</span><br><span class="line">        RegisterRouterFunction(NEMO_API_LIVE_API11, <span class="built_in">std</span>::bind(&amp;NemoAppLive::api11, <span class="keyword">this</span>, _1, _2));</span><br><span class="line">        RegisterRouterFunction(NEMO_API_LIVE_API12, <span class="built_in">std</span>::bind(&amp;NemoAppLive::api12, <span class="keyword">this</span>, _1, _2));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 增减接口时 需要改多处代码 </span></span><br><span class="line">    <span class="comment">// 改错容易造成逻辑错误、运行时崩溃、某些平台编译通过某些平台编译失败等奇怪问题</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// CACHE 结构的维护</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Cache</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> bala;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> bala;</span><br><span class="line">        <span class="keyword">uint64_t</span> bala;</span><br><span class="line">        <span class="keyword">int64_t</span> bala;</span><br><span class="line">        <span class="keyword">int32_t</span> balbalabla1;</span><br><span class="line">        <span class="keyword">int32_t</span> adlfajskjal3;</span><br><span class="line">        <span class="keyword">int32_t</span> lakjdfalksfjdalw3;</span><br><span class="line">        <span class="keyword">int32_t</span> a2fli3jlakf;</span><br><span class="line">        <span class="keyword">int32_t</span> aldfkja32ka;</span><br><span class="line">        <span class="keyword">int32_t</span> lksdjfal3wia;</span><br><span class="line">        <span class="keyword">int32_t</span> lajflwkj3;</span><br><span class="line">        <span class="keyword">int32_t</span> alalskdfksj3ijf;</span><br><span class="line">        <span class="keyword">int32_t</span> ajlskfdjaliwf;</span><br><span class="line">        <span class="keyword">int32_t</span> lawfj3wkjaja;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">ToMap</span><span class="params">(Poco::VariantMap&amp; mapParams)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="comment">// 本地cache构造回包</span></span><br><span class="line">            <span class="comment">// 稍有不慎 经常缺参数 参数错误 类型转换crash 各种奇怪问题</span></span><br><span class="line">            <span class="comment">// 开发过程难免需求变更、后台字段变更，变更后更易出错</span></span><br><span class="line">            mapParams[<span class="string">&quot;lawfj3wkjaja&quot;</span>]      = bala.c_str()?bala.c_str():<span class="string">&quot;&quot;</span>; </span><br><span class="line">            mapParams[<span class="string">&quot;balbalabla1&quot;</span>]       = balbalabla1;</span><br><span class="line">            mapParams[<span class="string">&quot;adlfajskjal3&quot;</span>]      = adlfajskjal3;</span><br><span class="line">            mapParams[<span class="string">&quot;lakjdfalksfjdalw3&quot;</span>] = lakjdfalksfjdalw3;</span><br><span class="line">            mapParams[<span class="string">&quot;a2fli3jlakf&quot;</span>]       = a2fli3jlakf;</span><br><span class="line">            mapParams[<span class="string">&quot;aldfkja32ka&quot;</span>]       = aldfkja32ka;</span><br><span class="line">            mapParams[<span class="string">&quot;lksdjfal3wia&quot;</span>]      = lksdjfal3wia;</span><br><span class="line">            mapParams[<span class="string">&quot;lajflwkj3&quot;</span>]         = lajflwkj3;</span><br><span class="line">            mapParams[<span class="string">&quot;alalskdfksj3ijf&quot;</span>]   = alalskdfksj3ijf;</span><br><span class="line">            mapParams[<span class="string">&quot;ajlskfdjaliwf&quot;</span>]     = ajlskfdjaliwf;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">FromJson</span><span class="params">(<span class="keyword">const</span> NemoJsonParser&amp; json)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="comment">// 解析json</span></span><br><span class="line">            <span class="comment">// 类型错误轻则业务逻辑出错 重则直接crash查到头秃</span></span><br><span class="line">            <span class="comment">// 1. 稍有不慎 搞错字段 逻辑错误</span></span><br><span class="line">            <span class="comment">// 2. 后台如果改字段 需要变更多处代码 稍有不慎 逻辑错误</span></span><br><span class="line">            <span class="comment">// 3. 类型转换失效 稍有不慎 运行时崩溃</span></span><br><span class="line">             <span class="keyword">if</span> (json.HasMember(<span class="string">&quot;data&quot;</span>)) &#123;</span><br><span class="line">                 <span class="keyword">auto</span> data = json[<span class="string">&quot;data&quot;</span>];</span><br><span class="line">                 <span class="keyword">if</span> (data.HasMember(<span class="string">&quot;info&quot;</span>)) &#123;</span><br><span class="line">                     <span class="keyword">auto</span>             Info = data[<span class="string">&quot;info&quot;</span>];</span><br><span class="line">                     Poco::VariantMap rspMap;</span><br><span class="line">                     <span class="keyword">int</span>              state      = Info[<span class="string">&quot;_state&quot;</span>];</span><br><span class="line">                     uint64           lkajfds    = Info[<span class="string">&quot;lkajfds&quot;</span>];</span><br><span class="line">                     uint64           durationss = Info[<span class="string">&quot;durationss&quot;</span>];</span><br><span class="line">                     <span class="keyword">int</span>              usercount  = Info[<span class="string">&quot;usercount&quot;</span>];</span><br><span class="line">                     uint64           alwkjef    = Info[<span class="string">&quot;alwkjef&quot;</span>];</span><br><span class="line">                     uint64           lkdfsj     = Info[<span class="string">&quot;lkdfsj&quot;</span>];</span><br><span class="line">                     <span class="built_in">std</span>::<span class="built_in">string</span>      slkfaj     = Info[<span class="string">&quot;slkfaj&quot;</span>];</span><br><span class="line"></span><br><span class="line">                     rspMap[<span class="string">&quot;alwkjef&quot;</span>]    = alwkjef;</span><br><span class="line">                     rspMap[<span class="string">&quot;lkdfsj&quot;</span>]     = lkdfsj;</span><br><span class="line">                     rspMap[<span class="string">&quot;slkfaj&quot;</span>]     = slkfaj;</span><br><span class="line">                     rspMap[<span class="string">&quot;lkajfds&quot;</span>]    = lkajfds;</span><br><span class="line">                     rspMap[<span class="string">&quot;durationss&quot;</span>] = durationss;</span><br><span class="line">                     rspMap[<span class="string">&quot;usercount&quot;</span>]  = usercount;</span><br><span class="line">                     rspMap[<span class="string">&quot;_info&quot;</span>]      = rspMap;</span><br><span class="line">                     rspMap[<span class="string">&quot;_state&quot;</span>]     = state;</span><br><span class="line">                 &#125;</span><br><span class="line">                 <span class="comment">// ...省略好多代码</span></span><br><span class="line">             &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>这些其实都是”认真”二字可以cover的问题，但问题在于，开发阶段难免遇到各端需求变更、后台修改、接口意图变化、功能扩展等，以上痛点代码均有一个特点，如果涉及以上几点变更，都需要更改多处代码，有些是IDE无法提供帮助的，手动修改时极易出错，而且麻烦，懒才是第一生产力，于是要想办法解决这些问题。</p><h2 id="优化后代码示例"><a href="#优化后代码示例" class="headerlink" title="优化后代码示例"></a>优化后代码示例</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NemoAppDemo</span> :</span> <span class="keyword">public</span> API</span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 自动展开 完成声明与注册</span></span><br><span class="line">    <span class="comment">// clang-format off</span></span><br><span class="line">    NEMO_MACRO_ROUTE_API(NemoAppDemo, demo_api, api1,api2,api3,api4,api5,api6);</span><br><span class="line">    <span class="comment">// clang-format on</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// clang-format off</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user</span> &#123;</span></span><br><span class="line">      <span class="keyword">int64_t</span>     uid;            </span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">string</span> name;      </span><br><span class="line">      <span class="keyword">int32_t</span>     role;           </span><br><span class="line">      <span class="keyword">int32_t</span>     status;         </span><br><span class="line">      <span class="keyword">int32_t</span>     param1;         </span><br><span class="line">      <span class="keyword">int32_t</span>     param2;         </span><br><span class="line">      <span class="keyword">int32_t</span>     param3;         </span><br><span class="line">      <span class="comment">//..</span></span><br><span class="line">      <span class="comment">// 自动展开 完成json与C++结构体互相转换、 构造回包等</span></span><br><span class="line">      NEMO_STRUCT_PARSER(uid ,name ,role ,status ,param1 ,param2 ,param3 );</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// clang-format on</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="宏展开"><a href="#宏展开" class="headerlink" title="宏展开"></a>宏展开</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NemoAppDemo</span> :</span> <span class="keyword">public</span> API</span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">RegisterRouterFunctions</span><span class="params">(<span class="keyword">void</span>)</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        RegisterRouterFunction(<span class="string">&quot;/demo_api/api1&quot;</span>, <span class="built_in">std</span>::bind(&amp;NemoAppDemo::api1, <span class="keyword">this</span>, _1, _2));</span><br><span class="line">        RegisterRouterFunction(<span class="string">&quot;/demo_api/api2&quot;</span>, <span class="built_in">std</span>::bind(&amp;NemoAppDemo::api2, <span class="keyword">this</span>, _1, _2));</span><br><span class="line">        RegisterRouterFunction(<span class="string">&quot;/demo_api/api3&quot;</span>, <span class="built_in">std</span>::bind(&amp;NemoAppDemo::api3, <span class="keyword">this</span>, _1, _2));</span><br><span class="line">        RegisterRouterFunction(<span class="string">&quot;/demo_api/api4&quot;</span>, <span class="built_in">std</span>::bind(&amp;NemoAppDemo::api4, <span class="keyword">this</span>, _1, _2));</span><br><span class="line">        RegisterRouterFunction(<span class="string">&quot;/demo_api/api5&quot;</span>, <span class="built_in">std</span>::bind(&amp;NemoAppDemo::api5, <span class="keyword">this</span>, _1, _2));</span><br><span class="line">        RegisterRouterFunction(<span class="string">&quot;/demo_api/api6&quot;</span>, <span class="built_in">std</span>::bind(&amp;NemoAppDemo::api6, <span class="keyword">this</span>, _1, _2));</span><br><span class="line">        ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">api1</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; api, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; params)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">api2</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; api, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; params)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">api3</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; api, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; params)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">api4</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; api, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; params)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">api5</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; api, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; params)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">api6</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; api, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; params)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user</span> &#123;</span></span><br><span class="line">        <span class="keyword">int64_t</span>     uid;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> name;</span><br><span class="line">        <span class="keyword">int32_t</span>     role;</span><br><span class="line">        <span class="keyword">int32_t</span>     status;</span><br><span class="line">        <span class="keyword">int32_t</span>     param1;</span><br><span class="line">        <span class="keyword">int32_t</span>     param2;</span><br><span class="line">        <span class="keyword">int32_t</span>     param3;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">FromJson</span><span class="params">(<span class="keyword">const</span> ZegoJsonParser&amp; json)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">bool</span> changed = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (json.HasMember(<span class="string">&quot;uid&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">decltype</span>(uid) tmpVar = (<span class="keyword">decltype</span>(uid))(json[<span class="string">&quot;uid&quot;</span>]); <span class="comment">//这里使用重载的转换函数</span></span><br><span class="line">                <span class="keyword">if</span> (tmpVar != uid) &#123;</span><br><span class="line">                    changed |= <span class="literal">true</span>;</span><br><span class="line">                    uid = tmpVar;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (json.HasMember(<span class="string">&quot;name&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">decltype</span>(name) tmpVar = (<span class="keyword">decltype</span>(name))(json[<span class="string">&quot;name&quot;</span>]); <span class="comment">//这里使用重载的转换函数</span></span><br><span class="line">                <span class="keyword">if</span> (tmpVar != name) &#123;</span><br><span class="line">                    changed |= <span class="literal">true</span>;</span><br><span class="line">                    name = tmpVar;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (json.HasMember(<span class="string">&quot;role&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">decltype</span>(role) tmpVar = (<span class="keyword">decltype</span>(role))(json[<span class="string">&quot;role&quot;</span>]); <span class="comment">//这里使用重载的转换函数</span></span><br><span class="line">                <span class="keyword">if</span> (tmpVar != role) &#123;</span><br><span class="line">                    changed |= <span class="literal">true</span>;</span><br><span class="line">                    role = tmpVar;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (json.HasMember(<span class="string">&quot;status&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">decltype</span>(status) tmpVar = (<span class="keyword">decltype</span>(status))(json[<span class="string">&quot;status&quot;</span>]); <span class="comment">//这里使用重载的转换函数</span></span><br><span class="line">                <span class="keyword">if</span> (tmpVar != status) &#123;</span><br><span class="line">                    changed |= <span class="literal">true</span>;</span><br><span class="line">                    status = tmpVar;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (json.HasMember(<span class="string">&quot;param1&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">decltype</span>(param1) tmpVar = (<span class="keyword">decltype</span>(param1))(json[<span class="string">&quot;param1&quot;</span>]); <span class="comment">//这里使用重载的转换函数</span></span><br><span class="line">                <span class="keyword">if</span> (tmpVar != param1) &#123;</span><br><span class="line">                    changed |= <span class="literal">true</span>;</span><br><span class="line">                    param1 = tmpVar;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (json.HasMember(<span class="string">&quot;param2&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">decltype</span>(param2) tmpVar = (<span class="keyword">decltype</span>(param2))(json[<span class="string">&quot;param2&quot;</span>]); <span class="comment">//这里使用重载的转换函数</span></span><br><span class="line">                <span class="keyword">if</span> (tmpVar != param2) &#123;</span><br><span class="line">                    changed |= <span class="literal">true</span>;</span><br><span class="line">                    param2 = tmpVar;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (json.HasMember(<span class="string">&quot;param3&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">decltype</span>(param3) tmpVar = (<span class="keyword">decltype</span>(param3))(json[<span class="string">&quot;param3&quot;</span>]); <span class="comment">//这里使用重载的转换函数</span></span><br><span class="line">                <span class="keyword">if</span> (tmpVar != param3) &#123;</span><br><span class="line">                    changed |= <span class="literal">true</span>;</span><br><span class="line">                    param3 = tmpVar;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> changed;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">ToMap</span><span class="params">(Poco::VariantMap&amp; mapParams)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            mapParams[<span class="string">&quot;uid&quot;</span>]    = uid;</span><br><span class="line">            mapParams[<span class="string">&quot;name&quot;</span>]   = name;</span><br><span class="line">            mapParams[<span class="string">&quot;role&quot;</span>]   = role;</span><br><span class="line">            mapParams[<span class="string">&quot;status&quot;</span>] = status;</span><br><span class="line">            mapParams[<span class="string">&quot;param1&quot;</span>] = param1;</span><br><span class="line">            mapParams[<span class="string">&quot;param2&quot;</span>] = param2;</span><br><span class="line">            mapParams[<span class="string">&quot;param3&quot;</span>] = param3;</span><br><span class="line">            ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function">Poco::VariantMap <span class="title">ToMap</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            Poco::VariantMap mapParams;</span><br><span class="line">            mapParams[<span class="string">&quot;uid&quot;</span>]    = uid;</span><br><span class="line">            mapParams[<span class="string">&quot;name&quot;</span>]   = name;</span><br><span class="line">            mapParams[<span class="string">&quot;role&quot;</span>]   = role;</span><br><span class="line">            mapParams[<span class="string">&quot;status&quot;</span>] = status;</span><br><span class="line">            mapParams[<span class="string">&quot;param1&quot;</span>] = param1;</span><br><span class="line">            mapParams[<span class="string">&quot;param2&quot;</span>] = param2;</span><br><span class="line">            mapParams[<span class="string">&quot;param3&quot;</span>] = param3;</span><br><span class="line">            ;</span><br><span class="line">            <span class="keyword">return</span> mapParams;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="宏编程开发需求"><a href="#宏编程开发需求" class="headerlink" title="宏编程开发需求"></a>宏编程开发需求</h2><p>回顾使用方法</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NemoAppDemo</span> :</span> <span class="keyword">public</span> API</span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 自动展开 完成声明与注册</span></span><br><span class="line">    <span class="comment">// clang-format off</span></span><br><span class="line">    NEMO_MACRO_ROUTE_API(NemoAppDemo , demo_api , api1 , api2 , api3 , api4 , api5 , api6);</span><br><span class="line">    <span class="comment">// clang-format on</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// clang-format off</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user</span> &#123;</span></span><br><span class="line">      <span class="keyword">int64_t</span>     uid;            </span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">string</span> name;      </span><br><span class="line">      <span class="keyword">int32_t</span>     role;           </span><br><span class="line">      <span class="keyword">int32_t</span>     status;         </span><br><span class="line">      <span class="keyword">int32_t</span>     param1;         </span><br><span class="line">      <span class="keyword">int32_t</span>     param2;         </span><br><span class="line">      <span class="keyword">int32_t</span>     param3;         </span><br><span class="line">      <span class="comment">//..</span></span><br><span class="line">      <span class="comment">// 自动展开 完成json与C++结构体互相转换、 构造回包等</span></span><br><span class="line">      NEMO_STRUCT_PARSER(uid , name , role , status , param1 , param2 , param3 );</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// clang-format on</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>增加api时，向NEMO_MACRO_ROUTE_API的括号里直接塞就好</li><li>增加属性字段更改结构体时，直接添加到NEMO_STRUCT_PARSER的参数中</li></ol><p>所以我们要实现的基本功能为： 遍历变长宏参数 进行统一的特殊处理</p><p>由此需求出发，依赖很多的小技巧和手法，最终完成开发并适配各平台。</p><h1 id="技术要点描述"><a href="#技术要点描述" class="headerlink" title="技术要点描述"></a>技术要点描述</h1><h2 id="预处理基本原理"><a href="#预处理基本原理" class="headerlink" title="预处理基本原理"></a>预处理基本原理</h2><p>预处理基本步骤：</p><ol><li>在进入宏函数前，所有 宏参数 会先进行一次 预扫描 (prescan)，完全展开 未用于 拼接标识符 或 获取字面量 的所有参数</li><li>在宏函数展开时，用（预扫描展开后的）参数替换 展开目标里的 同名符号</li><li>在宏函数展开后，替换后的文本会进行 二次扫描(scan twice)，继续展开 结果里出现的宏</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">s&#x3D;&gt;start: 开始</span><br><span class="line">DetectMacro&#x3D;&gt;condition: 是否存在宏</span><br><span class="line">ApplyNumberSymbol&#x3D;&gt;subroutine: 若有#&#x2F;## 则拼接标识符 或 获取字面量</span><br><span class="line">GoProcesssPrecan&#x3D;&gt;operation: 进入预扫描阶段</span><br><span class="line">DoneProcessPrescan&#x3D;&gt;operation: 预扫描阶段结束</span><br><span class="line">CheckPreParamNumber&#x3D;&gt;condition: 参数个数是否匹配</span><br><span class="line">CheckPostParamNumber&#x3D;&gt;condition: 参数个数是否匹配</span><br><span class="line">CheckParam&#x3D;&gt;condition: 宏参数是否用于 #&#x2F;##</span><br><span class="line">ParamExpend&#x3D;&gt;subroutine: 宏实参参数 按此流程展开</span><br><span class="line">ParamReplace&#x3D;&gt;operation: 宏展开 参数符号替换</span><br><span class="line">success&#x3D;&gt;end: 成功</span><br><span class="line">error&#x3D;&gt;end: 失败</span><br><span class="line"></span><br><span class="line">s-&gt;ApplyNumberSymbol-&gt;DetectMacro</span><br><span class="line">DetectMacro(no)-&gt;success</span><br><span class="line">DetectMacro(yes)-&gt;CheckPreParamNumber</span><br><span class="line">CheckPreParamNumber(no)-&gt;error</span><br><span class="line">CheckPreParamNumber(yes)-&gt;GoProcesssPrecan-&gt;CheckParam</span><br><span class="line">CheckParam(no)-&gt;ParamExpend(right)-&gt;CheckPostParamNumber</span><br><span class="line">CheckParam(yes)-&gt;DoneProcessPrescan-&gt;ParamReplace</span><br><span class="line">CheckPostParamNumber(yes)-&gt;DoneProcessPrescan-&gt;ParamReplace</span><br><span class="line">CheckPostParamNumber(no)-&gt;error</span><br><span class="line">ParamReplace(left)-&gt;ApplyNumberSymbol</span><br></pre></td></tr></table></figure><p><img data-src="/images/posts/macro/macro01.png" alt="预处理流程图"></p><table><thead><tr><th>步骤</th><th>说明</th></tr></thead><tbody><tr><td>ApplyNumberSymbol</td><td>拼接标识符 或 获取字面量</td></tr><tr><td>ParamNumberCheck</td><td>参数个数是否匹配</td></tr><tr><td>CheckParam</td><td>宏参数是否用于 拼接标识符 或 获取字面量</td></tr><tr><td>ParamExpend</td><td>宏实参参数展开</td></tr><tr><td>ParamReplace</td><td>参数符号替换</td></tr><tr><td>重复</td><td>是否仍存在宏 若存在 回到第一步</td></tr></tbody></table><h2 id="惰性求值、延迟调用、延迟展开"><a href="#惰性求值、延迟调用、延迟展开" class="headerlink" title="惰性求值、延迟调用、延迟展开"></a>惰性求值、延迟调用、延迟展开</h2><p>拼接标识符/获取字面量会终止局部宏展开，故需此技术。</p><h3 id="1-举例说明-对预扫描阶段的影响"><a href="#1-举例说明-对预扫描阶段的影响" class="headerlink" title="1. 举例说明#/##对预扫描阶段的影响"></a>1. 举例说明#/##对预扫描阶段的影响</h3><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FOO(SYMBOL) foo_ ## SYMBOL</span></span><br><span class="line"><span class="built_in">FOO</span>(<span class="built_in">bar</span>)    <span class="comment">// -&gt; foo_bar  it&#x27;s ok </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BAR() bar</span></span><br><span class="line"><span class="built_in">FOO</span>(<span class="built_in">BAR</span>())  <span class="comment">// -&gt; foo_BAR()  not foo_bar</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 先检查参数 FOO(BAR()) -&gt; foo_ ## BAR()  该参数用于拼接标识符/获取字面量 不允许展开</span></span><br><span class="line"><span class="comment">// 2. 宏展开 foo_ ## BAR() </span></span><br><span class="line"><span class="comment">// 3. 应用## 合并为 foo_BAR()</span></span><br></pre></td></tr></table></figure><p>即：拼接标识符/获取字面量会终止局部宏展开</p><p>解决方法： 延迟展开</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define FOOimpl(SYMBOL) foo_ ## SYMBOL</span></span><br><span class="line"><span class="comment">#define FOO(SYMBOL) FOOimpl(SYMBOL)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#define BAR() bar</span></span><br><span class="line">FOO(BAR())  </span><br><span class="line">    <span class="regexp">//</span> <span class="number">1</span>. 先检查参数 FOO(BAR()) -&gt; FOOimpl(SYMBOL)  并未用于拼接标识符 或 获取字面量 允许展开</span><br><span class="line">    <span class="regexp">//</span> <span class="number">2</span>. 宏实参参数展开 FOO(bar)  </span><br><span class="line">    <span class="regexp">//</span> <span class="number">3</span>. 宏展开 FOOimpl(bar)</span><br><span class="line">    <span class="regexp">//</span> <span class="number">4</span>. 再次扫描 展开为  foo_ <span class="comment">## bar</span></span><br><span class="line">    <span class="regexp">//</span> <span class="number">5</span>. 拼接标识符 最终展开为foo_bar</span><br></pre></td></tr></table></figure><h3 id="其他形式的延迟调用、惰性求值等"><a href="#其他形式的延迟调用、惰性求值等" class="headerlink" title="其他形式的延迟调用、惰性求值等"></a>其他形式的延迟调用、惰性求值等</h3><p>第一次宏展开 先返回宏函数， 拼接后 延迟调用</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_GET_N(N, ...)     NEMO_MACRO_CONCAT(NEMO_MACRO_GET_N_, N)(__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_GET_N_0(_0, ...)                                     _0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_GET_N_1(_0, _1, ...)                                 _1</span></span><br></pre></td></tr></table></figure><p>元组形式的延迟调用 （涉及宏编程较为复杂的元组打包、元组解包等）</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_APPLY(F, M)           NEMO_MACRO_APPLYimpl(F, M)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_APPLYimpl(F, M)       F M</span></span><br><span class="line"><span class="comment">// example</span></span><br><span class="line">NEMO_MACRO_APPLY(some_function, (a,b,c,d) )</span><br></pre></td></tr></table></figure><p>处理特殊输入</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FOO(T) int foo(T t)</span></span><br><span class="line">FOO(<span class="built_in">std</span>::<span class="built_in">map</span>&lt;a,b&gt;) <span class="comment">// error too many params</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REMOVE_PARENSimpl(...) __VA_ARGS__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REMOVE_PARENS(T) REMOVE_PARENSimpl T</span></span><br><span class="line"></span><br><span class="line">FOO(REMOVE_PARENS(<span class="built_in">std</span>::<span class="built_in">map</span>&lt;a,b&gt;)) </span><br><span class="line"><span class="comment">// 1. 预扫描 FOO(REMOVE_PARENSimpl (std::map&lt;a,b&gt;)) </span></span><br><span class="line"><span class="comment">// 2. 宏展开 int foo(REMOVE_PARENSimpl (std::map&lt;a,b&gt;))  t)</span></span><br><span class="line"><span class="comment">// 3. 再次展开 int foo(std::map&lt;a,b&gt; t) </span></span><br></pre></td></tr></table></figure><h2 id="下标访问"><a href="#下标访问" class="headerlink" title="下标访问"></a>下标访问</h2><p>既然要遍历所有参数，我们首先需要一个 “获取特定参数的宏——下标访问”</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">//  USAGE::</span></span><br><span class="line"><span class="comment">//    NEMO_MACRO_GET_N(0,a,b,c) will expend to a</span></span><br><span class="line"><span class="comment">//    NEMO_MACRO_GET_N(1,a,b,c) will expend to b</span></span><br><span class="line"><span class="comment">//    NEMO_MACRO_GET_N(2,a,b,c) will expend to c</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    NEMO_MACRO_GET_TUPLE_N(0,(a,b,c)) will expend to a</span></span><br><span class="line"><span class="comment">//    NEMO_MACRO_GET_TUPLE_N(1,(a,b,c)) will expend to b</span></span><br><span class="line"><span class="comment">//    NEMO_MACRO_GET_TUPLE_N(2,(a,b,c)) will expend to c</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_GET_N(N, ...)     NEMO_MACRO_EXPAND(NEMO_MACRO_CONCAT(NEMO_MACRO_GET_N_, N)(__VA_ARGS__))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_GET_TUPLE_N(N, T) NEMO_MACRO_APPLY(NEMO_MACRO_GET_N, (N, NEMO_MACRO_REMOVE_PARENS(T)))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_GET_N_0(_0, ...)                                     _0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_GET_N_1(_0, _1, ...)                                 _1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_GET_N_2(_0, _1, _2, ...)                             _2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_GET_N_3(_0, _1, _2, _3, ...)                         _3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_GET_N_4(_0, _1, _2, _3, _4, ...)                     _4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_GET_N_5(_0, _1, _2, _3, _4, _5, ...)                 _5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_GET_N_6(_0, _1, _2, _3, _4, _5, _6, ...)             _6</span></span><br></pre></td></tr></table></figure><h2 id="长度计算"><a href="#长度计算" class="headerlink" title="长度计算"></a>长度计算</h2><p>下标访问前，我们需要获取宏参数长度</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#define NEMO_MACRO_ARGS_COUNT_IMPL(...)                                                                                       \</span><br><span class="line">    NEMO_MACRO_GET_N(<span class="number">99</span>, __VA_ARGS__, <span class="number">99</span>, <span class="number">98</span>, <span class="number">97</span>, <span class="number">96</span>, <span class="number">95</span>, <span class="number">94</span>, <span class="number">93</span>, <span class="number">92</span>, <span class="number">91</span>, <span class="number">90</span>, <span class="number">89</span>, <span class="number">88</span>, <span class="number">87</span>, <span class="number">86</span>, <span class="number">85</span>, <span class="number">84</span>, <span class="number">83</span>, <span class="number">82</span>, <span class="number">81</span>, <span class="number">80</span>, <span class="number">79</span>, <span class="number">78</span>, \</span><br><span class="line">      <span class="number">77</span>, <span class="number">76</span>, <span class="number">75</span>, <span class="number">74</span>, <span class="number">73</span>, <span class="number">72</span>, <span class="number">71</span>, <span class="number">70</span>, <span class="number">69</span>, <span class="number">68</span>, <span class="number">67</span>, <span class="number">66</span>, <span class="number">65</span>, <span class="number">64</span>, <span class="number">63</span>, <span class="number">62</span>, <span class="number">61</span>, <span class="number">60</span>, <span class="number">59</span>, <span class="number">58</span>, <span class="number">57</span>, <span class="number">56</span>, <span class="number">55</span>, <span class="number">54</span>, <span class="number">53</span>, <span class="number">52</span>, <span class="number">51</span>, <span class="number">50</span>, <span class="number">49</span>, <span class="number">48</span>, \</span><br><span class="line">      <span class="number">47</span>, <span class="number">46</span>, <span class="number">45</span>, <span class="number">44</span>, <span class="number">43</span>, <span class="number">42</span>, <span class="number">41</span>, <span class="number">40</span>, <span class="number">39</span>, <span class="number">38</span>, <span class="number">37</span>, <span class="number">36</span>, <span class="number">35</span>, <span class="number">34</span>, <span class="number">33</span>, <span class="number">32</span>, <span class="number">31</span>, <span class="number">30</span>, <span class="number">29</span>, <span class="number">28</span>, <span class="number">27</span>, <span class="number">26</span>, <span class="number">25</span>, <span class="number">24</span>, <span class="number">23</span>, <span class="number">22</span>, <span class="number">21</span>, <span class="number">20</span>, <span class="number">19</span>, <span class="number">18</span>, \</span><br><span class="line">      <span class="number">17</span>, <span class="number">16</span>, <span class="number">15</span>, <span class="number">14</span>, <span class="number">13</span>, <span class="number">12</span>, <span class="number">11</span>, <span class="number">10</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>很有趣的小技巧，宏编程经常用这种东西，称为穷举/遍历，这种手法会有参数个数限制，但一般不需要支持太多的参数 99足够。</p><p>__VA_ARGS__展开后</p><ol><li>若__VA_ARGS__有一个参数 GET_N会得到1</li><li>若__VA_ARGS__有2个参数 GET_N会得到2</li></ol><p>完成长度计算</p><p>虽然NEMO_MACRO_ARGS_COUNT_IMPL看上去很美好，但当__VA_ARGS__参数个数为0时,会展开为<code>NEMO_MACRO_GET_N(99, , 99, 98, 97, 96, ...)</code>， 依然会返回1，于是我们为了完善GET_N，需要实现长度判空, 为了实现长度判空，我们需要一系列宏，如布尔转换与逻辑运算、条件选择等。</p><h2 id="布尔转换与逻辑运算"><a href="#布尔转换与逻辑运算" class="headerlink" title="布尔转换与逻辑运算"></a>布尔转换与逻辑运算</h2><p>这里技巧类似 也应用了遍历与穷举</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">//  USAGE::</span></span><br><span class="line"><span class="comment">//    布尔转换 与 逻辑运算</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_BOOL(N) NEMO_MACRO_GET_N(N, NEMO_MACRO_BOOL_TABLE())</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_BOOL_TABLE()                                                                                                  \</span></span><br><span class="line">    <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>,   \</span><br><span class="line">      <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, \</span><br><span class="line">      <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  N 最大为99 仅预编译时使用</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_NOT(N) NEMO_MACRO_GET_N(N, NEMO_MACRO_NOT_TABLE())</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_NOT_TABLE()                                                                                                   \</span></span><br><span class="line">    <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,   \</span><br><span class="line">      <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, \</span><br><span class="line">      <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_AND(A, B)      NEMO_MACRO_AND_IMPL(NEMO_MACRO_BOOL(A), NEMO_MACRO_BOOL(B))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_AND_IMPL(A, B) NEMO_MACRO_CONCAT(NEMO_MACRO_AND_, NEMO_MACRO_CONCAT(A, B))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_AND_00 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_AND_01 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_AND_10 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_AND_11 1</span></span><br></pre></td></tr></table></figure><h2 id="条件选择"><a href="#条件选择" class="headerlink" title="条件选择"></a>条件选择</h2><p>使用拼接与二阶段展开实现条件选择</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">//  USAGE::</span></span><br><span class="line"><span class="comment">//    条件选择</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_IF(PRED, THEN, ELSE) NEMO_MACRO_CONCAT(NEMO_MACRO_IF_, NEMO_MACRO_BOOL(PRED))(THEN, ELSE)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_IF_1(THEN, ELSE)     THEN</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_IF_0(THEN, ELSE)     ELSE</span></span><br></pre></td></tr></table></figure><p>注：宏编程的条件选择中 如果选择了THEN ELSE会从代码中消失 不会有任何编译错误，这其实是个优点，因为使用这个宏时，一般本意是选择性展开，选择THEN时，ELSE如果继续展开大概率展开失败。</p><h2 id="逗号判断"><a href="#逗号判断" class="headerlink" title="逗号判断"></a>逗号判断</h2><p>判断宏中是否有逗号</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">//  USAGE::</span></span><br><span class="line"><span class="comment">//    判断宏中是否有逗号</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_HAS_COMMA(...)                                                                                                \</span></span><br><span class="line">    NEMO_MACRO_EXPAND(NEMO_MACRO_GET_N_100(__VA_ARGS__, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>,  \</span><br><span class="line">      <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, \</span><br><span class="line">      <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br></pre></td></tr></table></figure><h2 id="长度判空"><a href="#长度判空" class="headerlink" title="长度判空"></a>长度判空</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">//  USAGE::</span></span><br><span class="line"><span class="comment">//    长度判空</span></span><br><span class="line"><span class="comment">//    NEMO_MACRO_IS_EMPTY()          ;// will expand to -&gt; 1</span></span><br><span class="line"><span class="comment">//    NEMO_MACRO_IS_EMPTY(foo)       ;// will expand to -&gt; 0</span></span><br><span class="line"><span class="comment">//    NEMO_MACRO_IS_EMPTY(foo())     ;// will expand to -&gt; 0</span></span><br><span class="line"><span class="comment">//    NEMO_MACRO_IS_EMPTY(())        ;// will expand to -&gt; 0</span></span><br><span class="line"><span class="comment">//    NEMO_MACRO_IS_EMPTY(()foo)     ;// will expand to -&gt; 0</span></span><br><span class="line"><span class="comment">//    NEMO_MACRO_IS_EMPTY(PP_EMPTY)  ;// will expand to -&gt; 0</span></span><br><span class="line"><span class="comment">//    NEMO_MACRO_IS_EMPTY(NEMO_MACRO_COMMA)  ;// will expand to -&gt; 0</span></span><br><span class="line"><span class="comment">//    NEMO_MACRO_IS_EMPTY(, )        ;// will expand to -&gt; 0</span></span><br><span class="line"><span class="comment">//    NEMO_MACRO_IS_EMPTY(foo, bar)  ;// will expand to -&gt; 0</span></span><br><span class="line"><span class="comment">//    NEMO_MACRO_IS_EMPTY(, , , )    ;// will expand to -&gt; 0</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 借助 NEMO_MACRO_GET_N()，我们可以检查 变长参数是否为空：</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_IS_EMPTY(...)                                                                                              \</span></span><br><span class="line">    NEMO_MACRO_EXPAND(NEMO_MACRO_AND(                                                                                         \</span><br><span class="line">      NEMO_MACRO_AND(NEMO_MACRO_NOT(NEMO_MACRO_HAS_COMMA(__VA_ARGS__)), NEMO_MACRO_NOT(NEMO_MACRO_HAS_COMMA(__VA_ARGS__()))), \</span><br><span class="line">      NEMO_MACRO_AND(NEMO_MACRO_NOT(NEMO_MACRO_HAS_COMMA(NEMO_MACRO_COMMA_V __VA_ARGS__)),                                    \</span><br><span class="line">        NEMO_MACRO_HAS_COMMA(NEMO_MACRO_COMMA_V __VA_ARGS__()))))</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_COMMA_V(...) ,</span></span><br></pre></td></tr></table></figure><h2 id="完善的长度判断"><a href="#完善的长度判断" class="headerlink" title="完善的长度判断"></a>完善的长度判断</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_ARGS_COUNT(...) \</span></span><br><span class="line">    NEMO_MACRO_EXPAND(NEMO_MACRO_IF(NEMO_MACRO_IS_EMPTY(__VA_ARGS__), <span class="number">0</span>, NEMO_MACRO_ARGS_COUNT_IMPL(__VA_ARGS__)))</span><br></pre></td></tr></table></figure><h2 id="借助以上N点原理，获取解决痛点的核心技术：宏遍历"><a href="#借助以上N点原理，获取解决痛点的核心技术：宏遍历" class="headerlink" title="借助以上N点原理，获取解决痛点的核心技术：宏遍历"></a>借助以上N点原理，获取解决痛点的核心技术：宏遍历</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">//  clang-format off</span></span><br><span class="line"><span class="comment">//  NEMO_MACRO_N</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  USAGE1::</span></span><br><span class="line"><span class="comment">//    NEMO_MACRO_N(MACRO_F,param,a,b,c,d,e,f) will expend to MACRO_F(param,a)MACRO_F(param,b)MACRO_F(param,c)MACRO_F(param,d)MACRO_F(param,e)MACRO_F(param,f)</span></span><br><span class="line"><span class="comment">// clang-format on</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_N(NEMO_MACRO_N_F, NEMO_MACRO_N_P, ...) \</span></span><br><span class="line">    NEMO_MACRO_EXPAND(                                    \</span><br><span class="line">      NEMO_MACRO_CONCAT(NEMO_MACRO_N_IMPL_, NEMO_MACRO_ARGS_COUNT(__VA_ARGS__))(NEMO_MACRO_N_F, NEMO_MACRO_N_P, __VA_ARGS__))</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_N_IMPL(F, P, M)         F(P, M)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_N_IMPL_1(F, P, M)       NEMO_MACRO_N_IMPL(F, P, M)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_N_IMPL_2(F, P, M, ...)  NEMO_MACRO_EXPAND(NEMO_MACRO_N_IMPL(F, P, M) NEMO_MACRO_N_IMPL_1(F, P, __VA_ARGS__))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_N_IMPL_3(F, P, M, ...)  NEMO_MACRO_EXPAND(NEMO_MACRO_N_IMPL(F, P, M) NEMO_MACRO_N_IMPL_2(F, P, __VA_ARGS__))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_N_IMPL_4(F, P, M, ...)  NEMO_MACRO_EXPAND(NEMO_MACRO_N_IMPL(F, P, M) NEMO_MACRO_N_IMPL_3(F, P, __VA_ARGS__))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_N_IMPL_5(F, P, M, ...)  NEMO_MACRO_EXPAND(NEMO_MACRO_N_IMPL(F, P, M) NEMO_MACRO_N_IMPL_4(F, P, __VA_ARGS__))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_N_IMPL_6(F, P, M, ...)  NEMO_MACRO_EXPAND(NEMO_MACRO_N_IMPL(F, P, M) NEMO_MACRO_N_IMPL_5(F, P, __VA_ARGS__))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_N_IMPL_7(F, P, M, ...)  NEMO_MACRO_EXPAND(NEMO_MACRO_N_IMPL(F, P, M) NEMO_MACRO_N_IMPL_6(F, P, __VA_ARGS__))</span></span><br></pre></td></tr></table></figure><h2 id="依赖宏遍历-解决问题"><a href="#依赖宏遍历-解决问题" class="headerlink" title="依赖宏遍历 解决问题"></a>依赖宏遍历 解决问题</h2><p>API处理</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">//  ROUTE API</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  USAGE::</span></span><br><span class="line"><span class="comment">//    NEMO_MACRO_ROUTE_API(className,apiBase,apiA,apiB,apiC,apiD)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//      will expend to (magic!)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//          public:</span></span><br><span class="line"><span class="comment">//            void RegisterRouterFunctions()</span></span><br><span class="line"><span class="comment">//            &#123;</span></span><br><span class="line"><span class="comment">//              RegisterRouterFunction(&quot;/apiBase/apiA&quot; , std::bind(&amp;className::apiA , this , _1 , _2));</span></span><br><span class="line"><span class="comment">//              RegisterRouterFunction(&quot;/apiBase/apiB&quot; , std::bind(&amp;className::apiB , this , _1 , _2));</span></span><br><span class="line"><span class="comment">//              RegisterRouterFunction(&quot;/apiBase/apiA&quot; , std::bind(&amp;className::apiA , this , _1 , _2));</span></span><br><span class="line"><span class="comment">//              RegisterRouterFunction(&quot;/apiBase/apiB&quot; , std::bind(&amp;className::apiB , this , _1 , _2));</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//          private:</span></span><br><span class="line"><span class="comment">//            unsigned int apiA(const std::string&amp; api, const std::string&amp; params);</span></span><br><span class="line"><span class="comment">//            unsigned int apiB(const std::string&amp; api, const std::string&amp; params);</span></span><br><span class="line"><span class="comment">//            unsigned int apiC(const std::string&amp; api, const std::string&amp; params);</span></span><br><span class="line"><span class="comment">//            unsigned int apiD(const std::string&amp; api, const std::string&amp; params);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// clang-format off</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_ROUTE_API(className, apiBase, ...)   NEMO_MACRO_EXPAND(  \</span></span><br><span class="line">    <span class="keyword">public</span>  :                                                               \</span><br><span class="line">        NEMO_MACRO_ROUTE_API_REG(className, apiBase, __VA_ARGS__)           \</span><br><span class="line">    <span class="keyword">private</span> :                                                               \</span><br><span class="line">        NEMO_MACRO_ROUTE_API_DEC(className, apiBase, __VA_ARGS__)           \</span><br><span class="line">    )</span><br><span class="line"><span class="comment">// register api</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_ROUTE_API_REG(className, apiBase, ...)                       \</span></span><br><span class="line">  void RegisterRouterFunctions(void) override                                   \</span><br><span class="line">  &#123;                                                                             \</span><br><span class="line">    NEMO_MACRO_N(NEMO_MACRO_ROUTE_API_REG_1, (className,apiBase), __VA_ARGS__); \</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_ROUTE_API_REG_1(PACKAGE_className_apiBase, M)                \</span></span><br><span class="line">  NEMO_MACRO_APPLY(NEMO_MACRO_ROUTE_API_REG_2,(NEMO_MACRO_REMOVE_PARENS(PACKAGE_className_apiBase),M));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_ROUTE_API_REG_2(className,apiBase,apiName) \</span></span><br><span class="line">  RegisterRouterFunction( NEMO_MACRO_STR(/apiBase/apiName), <span class="built_in">std</span>::bind(&amp;className::apiName, <span class="keyword">this</span>, _1, _2))</span><br><span class="line"><span class="comment">// decl api function</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_ROUTE_API_DEC(className, apiBase, ...) \</span></span><br><span class="line">  NEMO_MACRO_N(NEMO_MACRO_ROUTE_API_DEC_1, _, __VA_ARGS__);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_MACRO_ROUTE_API_DEC_1(_, funcName) unsigned int funcName(const std::string&amp; api, const std::string&amp; params);</span></span><br></pre></td></tr></table></figure><p>结构体parser</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">//  NEMO_STRUCT_PARSER</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  USAGE::</span></span><br><span class="line"><span class="comment">//    NEMO_STRUCT_PARSER(memberA,memberB,memberC,memberD)</span></span><br><span class="line"><span class="comment">//      will expend to</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//               public:</span></span><br><span class="line"><span class="comment">//                  bool  FromJson(const NemoJsonParser&amp; json)</span></span><br><span class="line"><span class="comment">//                  &#123;</span></span><br><span class="line"><span class="comment">//                    bool changed = false;</span></span><br><span class="line"><span class="comment">//                    if (json.HasMember(&quot;memberA&quot;)) &#123;</span></span><br><span class="line"><span class="comment">//                      decltype(varName) tmpVar = (decltype(memberA))(json[&quot;memberA&quot;]);</span></span><br><span class="line"><span class="comment">//                      if(memberA!=tmpVar)&#123;</span></span><br><span class="line"><span class="comment">//                          changed|=true;</span></span><br><span class="line"><span class="comment">//                          memberA = tmpVar;</span></span><br><span class="line"><span class="comment">//                      &#125;</span></span><br><span class="line"><span class="comment">//                    &#125;</span></span><br><span class="line"><span class="comment">//                    if (json.HasMember(&quot;memberB&quot;)) &#123;</span></span><br><span class="line"><span class="comment">//                      decltype(varName) tmpVar = (decltype(memberB))(json[&quot;memberB&quot;]);</span></span><br><span class="line"><span class="comment">//                      if(memberB!=tmpVar)&#123;</span></span><br><span class="line"><span class="comment">//                          changed|=true;</span></span><br><span class="line"><span class="comment">//                          memberB = tmpVar;</span></span><br><span class="line"><span class="comment">//                      &#125;</span></span><br><span class="line"><span class="comment">//                    &#125;</span></span><br><span class="line"><span class="comment">//                    if (json.HasMember(&quot;memberC&quot;)) &#123;</span></span><br><span class="line"><span class="comment">//                      decltype(varName) tmpVar = (decltype(memberC))(json[&quot;memberC&quot;]);</span></span><br><span class="line"><span class="comment">//                      if(memberC!=tmpVar)&#123;</span></span><br><span class="line"><span class="comment">//                          changed|=true;</span></span><br><span class="line"><span class="comment">//                          memberC = tmpVar;</span></span><br><span class="line"><span class="comment">//                      &#125;</span></span><br><span class="line"><span class="comment">//                    &#125;</span></span><br><span class="line"><span class="comment">//                    if (json.HasMember(&quot;memberD&quot;)) &#123;</span></span><br><span class="line"><span class="comment">//                      decltype(varName) tmpVar = (decltype(memberD))(json[&quot;memberD&quot;]);</span></span><br><span class="line"><span class="comment">//                      if(memberD!=tmpVar)&#123;</span></span><br><span class="line"><span class="comment">//                          changed|=true;</span></span><br><span class="line"><span class="comment">//                          memberD = tmpVar;</span></span><br><span class="line"><span class="comment">//                      &#125;</span></span><br><span class="line"><span class="comment">//                    &#125;</span></span><br><span class="line"><span class="comment">//                    return changed;</span></span><br><span class="line"><span class="comment">//                  &#125;;</span></span><br><span class="line"><span class="comment">//                  void ToMap(Poco::VariantMap&amp; mapParams)</span></span><br><span class="line"><span class="comment">//                  &#123;</span></span><br><span class="line"><span class="comment">//                    mapParams[&quot;memberA&quot;] = memberA;</span></span><br><span class="line"><span class="comment">//                    mapParams[&quot;memberB&quot;] = memberB;</span></span><br><span class="line"><span class="comment">//                    mapParams[&quot;memberC&quot;] = memberC;</span></span><br><span class="line"><span class="comment">//                    mapParams[&quot;memberD&quot;] = memberD;</span></span><br><span class="line"><span class="comment">//                  &#125;</span></span><br><span class="line"><span class="comment">//                  Poco::VariantMap ToMap(void)</span></span><br><span class="line"><span class="comment">//                  &#123;</span></span><br><span class="line"><span class="comment">//                    Poco::VariantMap mapParams;</span></span><br><span class="line"><span class="comment">//                    mapParams[&quot;memberA&quot;] = memberA;</span></span><br><span class="line"><span class="comment">//                    mapParams[&quot;memberB&quot;] = memberB;</span></span><br><span class="line"><span class="comment">//                    mapParams[&quot;memberC&quot;] = memberC;</span></span><br><span class="line"><span class="comment">//                    mapParams[&quot;memberD&quot;] = memberD;</span></span><br><span class="line"><span class="comment">//                    return mapParams;</span></span><br><span class="line"><span class="comment">//                  &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_STRUCT_PARSER(...)                                                                                             \</span></span><br><span class="line">   <span class="keyword">public</span>:                                                                                                                  \</span><br><span class="line">    bool FromJson(const NemoJsonParser&amp; json)                                                                               \</span><br><span class="line">    &#123;                                                                                                                       \</span><br><span class="line">        <span class="keyword">bool</span> changed = <span class="literal">false</span>;                                                                                               \</span><br><span class="line">        NEMO_MACRO_N(NEMO_STRUCT_PARSER_FROMJSON, _, __VA_ARGS__);                                                          \</span><br><span class="line">        <span class="keyword">return</span> changed;                                                                                                     \</span><br><span class="line">    &#125;;                                                                                                                      \</span><br><span class="line">    <span class="function"><span class="keyword">void</span>             <span class="title">ToMap</span><span class="params">(Poco::VariantMap&amp; mapParams)</span> </span>&#123; NEMO_MACRO_N(NEMO_STRUCT_PARSER_TOMAP, mapParams, __VA_ARGS__); &#125; \</span><br><span class="line">    Poco::VariantMap ToMap(void)                                                                                            \</span><br><span class="line">    &#123;                                                                                                                       \</span><br><span class="line">        Poco::VariantMap mapParams;                                                                                         \</span><br><span class="line">        NEMO_MACRO_N(NEMO_STRUCT_PARSER_TOMAP, mapParams, __VA_ARGS__);                                                     \</span><br><span class="line">        <span class="keyword">return</span> mapParams;                                                                                                   \</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_STRUCT_PARSER_FROMJSON(_, varName)                                        \</span></span><br><span class="line">    <span class="keyword">if</span> (json.HasMember(NEMO_MACRO_STR(varName))) &#123;                                     \</span><br><span class="line">        <span class="keyword">decltype</span>(varName) tmpVar = (<span class="keyword">decltype</span>(varName))(json[NEMO_MACRO_STR(varName)]); \</span><br><span class="line">        <span class="keyword">if</span> (tmpVar != varName) &#123;                                                       \</span><br><span class="line">            changed |= <span class="literal">true</span>;                                                           \</span><br><span class="line">            varName = tmpVar;                                                          \</span><br><span class="line">        &#125;                                                                              \</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NEMO_STRUCT_PARSER_TOMAP(mapParams, varName) mapParams[NEMO_MACRO_STR(varName)] = varName;</span></span><br></pre></td></tr></table></figure><h1 id="踩坑记录"><a href="#踩坑记录" class="headerlink" title="踩坑记录"></a>踩坑记录</h1><h2 id="1-windows的预处理bug1"><a href="#1-windows的预处理bug1" class="headerlink" title="1. windows的预处理bug1"></a>1. windows的预处理bug1</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONCATimpl(a,b) a##b</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONCAT(a,b) CONCATimpl(a,b) </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AA</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BB  </span></span><br><span class="line">CONCAT(B, CONCAT(A, A B)) </span><br><span class="line"><span class="comment">// 1. 预扫描  CONCAT(B, AA B))</span></span><br><span class="line"><span class="comment">// 2. 宏展开  CONCAT(B, AA B))</span></span><br><span class="line"><span class="comment">// 3. 预扫描  CONCAT(B,  B))</span></span><br><span class="line"><span class="comment">// 4. 宏展开  BB</span></span><br><span class="line"><span class="comment">// 5. 宏展开  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// --&gt; should be empyt</span></span><br><span class="line"><span class="comment">// bug msvc get</span></span><br><span class="line">    BAA B</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>但MSVC会获得 BAA B<br>当同名迭代调用时，且最终步骤带有#，则可能触发该bug。规避方法 使用延迟调用。</p><p>NEMO_MACRO_APPLY(CONCAT,(B, CONCAT(A, A B)))</p><p>see <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/62363585/why-is-msvc-preprocessor-concatenating-tokens-differently-than-gcc-and-clang?rq=1">https://stackoverflow.com/questions/62363585/why-is-msvc-preprocessor-concatenating-tokens-differently-than-gcc-and-clang?rq=1</a></p><p>##　2. windows的预处理bug2　__VA_ARGS__展开失败<br>在传统预处理器中，如果宏将其参数之一转发给另一个依赖宏，则在插入时，该参数不会 “解压缩”<br>see <a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/cpp/preprocessor/preprocessor-experimental-overview?view=vs-2019">https://docs.microsoft.com/zh-cn/cpp/preprocessor/preprocessor-experimental-overview?view=vs-2019</a></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ADD2impl(a1, a2)  (a1)+(a2)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ADD2(...) ADD2impl(__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, ADD2(<span class="number">1</span>, <span class="number">2</span>));</span><br><span class="line"><span class="comment">// should be printf(&quot;%d\n&quot;,1+2);</span></span><br><span class="line"><span class="comment">// msvc get  printf(&quot;%d\n&quot;,(1,2) +());</span></span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> F(x, ...) X = x and VA_ARGS = __VA_ARGS__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> G(...) F(__VA_ARGS__)</span></span><br><span class="line">F(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">G(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"><span class="comment">// F and G all should be </span></span><br><span class="line">    X = <span class="number">1</span> <span class="keyword">and</span> VA_ARGS = <span class="number">2</span>, <span class="number">3</span>;</span><br><span class="line">    X = <span class="number">1</span> <span class="keyword">and</span> VA_ARGS = <span class="number">2</span>, <span class="number">3</span>;</span><br><span class="line"><span class="comment">// bug msvc get</span></span><br><span class="line">    X = <span class="number">1</span> <span class="keyword">and</span> VA_ARGS = <span class="number">2</span>, <span class="number">3</span>;</span><br><span class="line">    X = <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> <span class="keyword">and</span> VA_ARGS = ;</span><br></pre></td></tr></table></figure><p>MSVC会将__VA_ARGS__视为单参数</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">msvc</span><br><span class="line">    G(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">    F(__VA_ARGS__)</span><br><span class="line">    X = x <span class="keyword">and</span> VA_ARGS = __VA_ARGS__</span><br></pre></td></tr></table></figure><p>规避方法： 但凡参数列表中有… 需要增加中间层 使其提前展开！</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#define NEMO_MACRO_EXPAND(...)         __VA_ARGS__</span><br><span class="line">#define G(...) NEMO_MACRO_EXPAND(<span class="name">F</span>(<span class="name">__VA_ARGS__</span>))<span class="comment">;</span></span><br><span class="line">        G(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>) is OK</span><br></pre></td></tr></table></figure><p>如果没有NEMO_MACRO_EXPAND<br>MSVC会将其当作单参数</p><p>see <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/5134523/msvc-doesnt-expand-va-args-correctly">https://stackoverflow.com/questions/5134523/msvc-doesnt-expand-va-args-correctly</a></p><h2 id="3-msvc-bug-3-重新扫描算法不符合标准"><a href="#3-msvc-bug-3-重新扫描算法不符合标准" class="headerlink" title="3. msvc bug 3 重新扫描算法不符合标准"></a>3. msvc bug 3 重新扫描算法不符合标准</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REMOVE_PATTEN(...) __VA_ARGS__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMPL1(prefix,value) do_thing_one( prefix, value)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMPL2(prefix,value) do_thing_two( prefix, value)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DO_THING(macro_switch, b) CAT(IMPL, macro_switch) ECHO(( <span class="meta-string">&quot;Hello&quot;</span>, b))</span></span><br><span class="line"></span><br><span class="line">DO_THING(<span class="number">1</span>, <span class="string">&quot;World&quot;</span>); <span class="comment">//-&gt; do_thing_one(&quot;hello&quot;,&quot;world&quot;) or IMPL1 ( &quot;Hello&quot;,&quot;World&quot;);</span></span><br><span class="line">DO_THING(<span class="number">2</span>, <span class="string">&quot;World&quot;</span>); <span class="comment">//-&gt; do_thing_two(&quot;hello&quot;,&quot;world&quot;) or IMPL1 ( &quot;Hello&quot;,&quot;World&quot;);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// msvc</span></span><br><span class="line">    <span class="comment">//-&gt; do_thing_one(&quot;hello&quot;,&quot;world&quot;)  </span></span><br><span class="line">    <span class="comment">//-&gt; do_thing_two(&quot;hello&quot;,&quot;world&quot;)</span></span><br><span class="line"><span class="comment">// gcc clang （符合标准）</span></span><br><span class="line">    <span class="comment">//-&gt;IMPL1 ( &quot;Hello&quot;,&quot;World&quot;);</span></span><br><span class="line">    <span class="comment">//-&gt;IMPL1 ( &quot;Hello&quot;,&quot;World&quot;);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// DO_THING(1, &quot;World&quot;) 扩展到 CAT(IMPL, 1) ECHO((&quot;Hello&quot;, &quot;World&quot;))</span></span><br><span class="line"><span class="comment">// CAT(IMPL, 1) 展开到 IMPL ## 1 ，将扩展到 IMPL1</span></span><br><span class="line"><span class="comment">// 现在，令牌处于以下状态： IMPL1 ECHO((&quot;Hello&quot;, &quot;World&quot;))</span></span><br><span class="line"><span class="comment">// 预处理器查找类似函数的宏标识符 IMPL1 。 由于后面不是 ( ，因此不会将其视为类似于函数的宏调用。</span></span><br><span class="line"><span class="comment">// 预处理器转到以下标记。 它将查找调用类似函数的宏 ECHO ECHO((&quot;Hello&quot;, &quot;World&quot;)) ，该宏将扩展到 (&quot;Hello&quot;, &quot;World&quot;)</span></span><br><span class="line"><span class="comment">// IMPL1 永远不会被视为展开，因此扩展的完整结果为： IMPL1(&quot;Hello&quot;, &quot;World&quot;);</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>解决方法 延迟展开，使其IMPL1展开时 后边是( 即可顺利展开<br><code>#define DO_THING(macro_switch, b) APPLY(CAT(IMPL, macro_switch),ECHO(( &quot;Hello&quot;, b))</code></p><h2 id="4-clang、MSVC-VA-ARGS-0参数BUG"><a href="#4-clang、MSVC-VA-ARGS-0参数BUG" class="headerlink" title="4. clang、MSVC  __VA_ARGS__ 0参数BUG"></a>4. clang、MSVC __VA_ARGS__ 0参数BUG</h2><p>先了解<code>##__VA_ARGS__与__VA_ARGS__</code>的区别</p><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">log(<span class="meta">format</span>,...)  c<span class="meta">clog(</span><span class="meta">format</span>,__VA_ARGS__);   | ==&gt; c<span class="meta">clog(</span><span class="meta">format</span>,); | 编译出错</span><br><span class="line">log(<span class="meta">format</span>,...)  c<span class="meta">clog(</span><span class="meta">format</span>,##__VA_ARGS__); | ==&gt; c<span class="meta">clog(</span><span class="meta">format</span>);  | pass</span><br></pre></td></tr></table></figure><p><code>##__VA_ARGS__</code>并非C/C++标准中的东西 是编译器扩展：当参数长度为0时，吃掉前面的逗号，而标准中并未说明__VA_ARGS__会eat逗号</p><p>但实际上 这里只有gcc是符合标准的 clang、MSVC 无论哪个宏，都会eat逗号。</p><p>这个bug在判断参数长度、判断参数是否有逗号等情况时会遇到。</p><h2 id="5-GCC安卓-奇怪的换行bug"><a href="#5-GCC安卓-奇怪的换行bug" class="headerlink" title="5. GCC安卓 奇怪的换行bug"></a>5. GCC安卓 奇怪的换行bug</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NEMO_MACRO_ROUTE_API(NemoAppMeetingRoom, demo_api, login_room, set_room_info, get_room_info, get_user_info, xxxAPI); <span class="regexp">//</span> is OK</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span> 代码太长 换个行吧</span><br><span class="line">NEMO_MACRO_ROUTE_API(NemoAppMeetingRoom, demo_api, login_room, set_room_info, get_room_info, </span><br><span class="line">    get_user_info , xxxAPI);</span><br><span class="line"><span class="regexp">//</span> WT? 找不到API get_user_info xxxAPI</span><br></pre></td></tr></table></figure><h2 id="6-MSVC-bug-fix"><a href="#6-MSVC-bug-fix" class="headerlink" title="6. MSVC bug-fix"></a>6. MSVC bug-fix</h2><p>2020年9月10日 MSVC:”我们正在更新 Microsoft c + + 预处理器来改善标准一致性、修复长久持续 bug 并更改正式定义的某些行为。”<br>十几年的bug，终于修复了， 可使用/Zc:preprocessor 启用符合标准的预处理器，但仅限 Visual Studio 2019 版本16.5以上</p><p>但预计很长时间以内，大家还是以有bug的msvc来开发复杂宏，以便兼容所有MSVC版本。</p><h1 id="其他概念"><a href="#其他概念" class="headerlink" title="其他概念"></a>其他概念</h1><p>宏数据结构 （元组 序列 列表）、符号匹配、递归重入、条件循环、数值比较、数值运算（C可使用 C++用constexpr即可)</p><p>参考资料</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="regexp">//</span>stackoverflow.com<span class="regexp">/questions/</span><span class="number">5134523</span>/msvc-doesnt-expand-va-args-correctly</span><br><span class="line">https:<span class="regexp">//</span>stackoverflow.com<span class="regexp">/questions/</span><span class="number">5134523</span>/msvc-doesnt-expand-va-args-correctly</span><br><span class="line">https:<span class="regexp">//</span>stackoverflow.com<span class="regexp">/questions/</span><span class="number">62363585</span>/why-is-msvc-preprocessor-concatenating-tokens-differently-than-gcc-and-clang?rq=<span class="number">1</span></span><br><span class="line">https:<span class="regexp">//</span>zhuanlan.zhihu.com<span class="regexp">/p/</span><span class="number">152354031</span></span><br><span class="line">https:<span class="regexp">//</span>zhuanlan.zhihu.com<span class="regexp">/p/</span><span class="number">59807834</span></span><br><span class="line">https:<span class="regexp">//</span>www.zhihu.com<span class="regexp">/question/</span><span class="number">40698752</span></span><br><span class="line">https:<span class="regexp">//</span>zhuanlan.zhihu.com<span class="regexp">/p/</span><span class="number">152354031</span></span><br><span class="line">https:<span class="regexp">//</span>docs.microsoft.com<span class="regexp">/zh-cn/</span>cpp<span class="regexp">/preprocessor/</span>preprocessor-experimental-overview?view=vs-<span class="number">2019</span></span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://yuanjiuzheng.com/blog/cc02/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/web/avatar-nemo3.jpg"><meta itemprop="name" content="Nemo.yeran"><meta itemprop="description" content="一直折腾一直爽"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Yeran"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/blog/cc02/" class="post-title-link" itemprop="url">【折腾笔记】看板娘</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-05-28 17:57:06" itemprop="dateCreated datePublished" datetime="2020-05-28T17:57:06+08:00">2020-05-28</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E6%8A%98%E8%85%BE%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">折腾笔记</span></a></span></span></div><div class="post-meta"><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>1.4k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>1 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>又来更新了，前两天把网站折腾利索,前端加上了看板娘的js源码,把Live2D模型搬到了服务器上做了看板娘的API,美滋滋,但小水管服务器加载速度太慢了。看板娘可是网站灵魂,要优化！于是开始了新一轮的折腾！（折腾完这一波，我也算是接触过前端相关技术了 23333）</p><p>目标：</p><ol><li>CDN加速（要快, ？？</li><li>不依赖别人（纸片人老婆怎么能用别人的</li><li>模型易增加（？？</li><li>源码可更改（尽量搞到非压缩非混淆的源码）</li></ol><h1 id="相关源码"><a href="#相关源码" class="headerlink" title="相关源码"></a>相关源码</h1><p>翻了翻github,找到了这些相关的库</p><ol><li><a target="_blank" rel="noopener" href="https://github.com/stevenjoezhang/live2d-widget">https://github.com/stevenjoezhang/live2d-widget</a></li><li><a target="_blank" rel="noopener" href="https://github.com/HCLonely/live2d.user.js">https://github.com/HCLonely/live2d.user.js</a></li><li><a target="_blank" rel="noopener" href="https://github.com/journey-ad/live2d_src">https://github.com/journey-ad/live2d_src</a></li><li><a target="_blank" rel="noopener" href="https://github.com/EYHN/hexo-helper-live2d">https://github.com/EYHN/hexo-helper-live2d</a></li><li><a target="_blank" rel="noopener" href="https://github.com/Eikanya/Live2d-model">https://github.com/Eikanya/Live2d-model</a></li></ol><p>emm,一开始是用的库1的代码,但有个问题,API和CDN方式冲突,API的话模型加载慢,CDN的话不能换衣服2333,所以打算改改看。看了看代码,根源在于live2d.min.js的接口就只接受一个json的path,以这个PATH的相对路径来查找模型资源。所以如果要改的话要么改到live2d.min.js里,要么把原来API返回的JSON都预备好,弃用API,直接给live2d接口CDN的JSON资源，通过换JSON来换衣服。但显然即麻烦又不够优雅，所以决定要改live2d.js。</p><p>但库1的live2d.min.js是已经压缩过的,变量名看起来好像也混淆过,难以修改,不是很想用,所以继续找了其他的库。</p><p>库2是一个浏览器插件的js源码，并不能直接移植到自己的网站上，但通过里面的一些做法可以得到启发：加载资源时用正则表达式把PATH替换成CDN的path，来即支持live2d-API 也支持CDN加速资源,</p><p>库3是基于库4<a target="_blank" rel="noopener" href="https://github.com/EYHN/hexo-helper-live2d">hexo-helper-live2d</a>改的,代码能读,功能看起来也OK最终决定基于库3来魔改。</p><p>第一次接触js，改了半天吧，还踩了不少坑，{ import/export，ES6的语法，babel的兼容性，Hexo的默认渲染 } 等问题，好在最后搞定了，踩坑的东西就不写了，网上一大把解决方案。</p><p>好像不写踩坑的东西，又没啥写的了？ 那写写吧</p><h1 id="踩坑日志"><a href="#踩坑日志" class="headerlink" title="踩坑日志"></a>踩坑日志</h1><ol><li>本地JS代码，和上传的代码不一样，很神奇，&lt;=会变成 &lt;= 1，一开始调试了好久，以为是js或者浏览器或者哪的bug，最后发现是忘了关HEXO的默认渲染，在HEXO的skip_render中添加路径即可。</li><li>用本地html文件做测试的时候，加载相对路径的css/js时报错“不支持file://”，emm最后还是hexo s，启server来调试比较方便。</li><li><code>type=&quot;module&quot;</code>才支持带有import/export的js代码，最后把js变成了单文件没这个问题了。</li><li>gulp压缩的时候，不支持ES6语法，看了看gulp的文档，有个Stage-0的plugins，再外加<a target="_blank" rel="noopener" href="https://github.com/facebook/regenerator/blob/master/packages/regenerator-runtime/runtime.js">runtime.js</a>，才算通过。</li><li>CDN的缓存，更改js不会及时生效，要用版本号/更改文件名等方式来刷新，好像给Github库打tag也行。</li></ol><h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><p>日常写C/C++，突然接触js的语法，不检查类型，不检查参数，变量全局，各种不一样，感觉，emm好松！但也挺爽挺好用。</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://yuanjiuzheng.com/blog/cc01/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/web/avatar-nemo3.jpg"><meta itemprop="name" content="Nemo.yeran"><meta itemprop="description" content="一直折腾一直爽"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Yeran"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/blog/cc01/" class="post-title-link" itemprop="url">【折腾笔记】个人网站</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-05-24 17:36:06" itemprop="dateCreated datePublished" datetime="2020-05-24T17:36:06+08:00">2020-05-24</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E6%8A%98%E8%85%BE%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">折腾笔记</span></a></span></span></div><div class="post-meta"><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>3.6k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>3 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>终于暂且算是把博客性质的个人网站折腾利索了，也算是日常不务正业吧，记录下折腾过程吧，以免哪天服务器挂了要重新折腾（希望不需要。</p><p>从14年开始搞个人网站，那时候用虚拟主机，便宜耐用，但配置差，网速慢，备份不方便，自由度极低，而且那时候网站程序是用的 WordPress ，Emm 可能是因为当时太菜了，觉得不好用，网站搬家也很费力，备份也不太方便，虽然有一次趁着打折续了五年的，但后来也弃了虚拟主机。</p><p>后来开始买国外或香港VPS，免备案，预装Ubuntu，一键xx面板，一键LNMP，面板后台操作一番，WordPress 网站就建起来了，体验还不错。不过感觉xx面板有点不安全，而且依赖性太强，既然是瞎折腾，隔着一层面板折腾来折腾去也的确没什么意思。</p><p>再后来docker火热，用 docker 搭了一个 WordPress 的，这个感觉蛮好的，备份一下docker的脚本，备份下数据库文件就好了，搬家也方便。但那时候没管理网站的注册机制，被脚本机器人注册了大量垃圾用户，而且也没怎么维护网站，后来数据库撑炸了，2333，再后来国外服务器总被封，各种原因也没再继续维护个人网站了。</p><p>中间还试过GitHub Page，那时候用的叫 JK什么（误）的静态框架，但没什么好看的主题，而且emm反正不是很喜欢，就没继续搞。</p><p>这波是2019年了，趁阿里云搞活动买了波基础机型，然后一直没动。直到有一天看到一个人的网站里有看板娘，emmmm，毕竟死宅，i了i了，于是就：”我也要这个！”，开始了这波Hexo博客的搭建。后面是留给自己的折腾笔记。</p><hr><h1 id="Hexo"><a href="#Hexo" class="headerlink" title="Hexo"></a>Hexo</h1><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>由于平时开发使用Windows+WSL，所以两个平台都试了下，都很香。</p><p>不过现在WSL的文件管理还不是很稳定，用Sublime浏览的时候，时而加载不出来，不是很方便，所以最后全都转到Windows下了（WSL近期要更新了 windows可以直接访问wsl文件，那时候应该比较好用，期待一下，就不暂时折腾win10更新的东西了）</p><p>依赖：</p><ol><li>git</li><li>node.js</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-cli -g</span><br><span class="line">npm config <span class="built_in">set</span> registry https://registry.npm.taobao.org</span><br><span class="line">hexo init blog</span><br><span class="line"><span class="built_in">cd</span> blog</span><br><span class="line">hexo new <span class="string">&quot;Hello Hexo&quot;</span></span><br><span class="line">hexo generate</span><br><span class="line">hexo server</span><br></pre></td></tr></table></figure><p>大概这样就运行起来了。</p><h2 id="配置自动发布"><a href="#配置自动发布" class="headerlink" title="配置自动发布"></a>配置自动发布</h2><p>emm Hexo支持很多种方式自动发布部署，rsync sftp ftpsync git，反正试到最后git最好用。rsync跨系统会有点坑在里面，sftp速度太慢，ftpsync现在的包并不好用，还要打补丁，打完补丁第一天还ok，第二天不好使了 2333。</p><p>反正最后折腾到只用git了，git到 GitHub 很简单，到阿里云服务器的话，我是搭了一个 Gitea 服务，然后传到自己的 Gitea 的库里面，然后在 Gitea 的 action 里配置自动发布，大概长这样。。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">git --work-tree=/var/www/html/xxxxx --git-dir=/home/git/gitea-repositories/xxx/xxx.git checkout -f</span><br></pre></td></tr></table></figure><p>所以hexo这里的自动发布 就只用git就ok了，github网速慢的问题可以走代理</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global http.proxy http://127.0.0.1:1080</span><br><span class="line">git config --global https.proxy https://127.0.0.1:1080</span><br></pre></td></tr></table></figure><p>而且Git可以配置公私钥来免登录，比较方便。</p><h2 id="hexo-asset-image"><a href="#hexo-asset-image" class="headerlink" title="hexo-asset-image"></a>hexo-asset-image</h2><p>这个包好像有个问题，一开始图片一直显示不出来，调试发现生成图片链接的相关逻辑不太对，后来把index.js替换掉了就好使了。</p><h2 id="主题"><a href="#主题" class="headerlink" title="主题"></a>主题</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> blog</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/next-theme/hexo-theme-next.git themes/next</span><br></pre></td></tr></table></figure><p>next主题还是很好用的，也比较喜欢，旧的next库很久不维护了，其中的主要贡献者另起炉灶开了新库（上面的链接）。</p><p><strong>关于配置文件</strong>。有两个配置文件，一个是Hexo的，一个是主题的配置文件，有办法统一只使用一个配置文件：在hexo的配置文件最下方增加<code>theme_config:</code>，然后把主题的配置文件内容全部copy到Hexo的下面，并增加2缩进，如：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">theme_config:</span></span><br><span class="line">  <span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line">  <span class="comment"># Theme Core Configuration Settings</span></span><br><span class="line">  <span class="comment"># See: https://theme-next.org/docs/theme-settings/</span></span><br><span class="line">  <span class="comment"># ---------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># If false, merge configs from `_data/next.yml` into default configuration (rewrite).</span></span><br><span class="line">  <span class="comment"># If true, will fully override default configuration by options from `_data/next.yml` (override). Only for NexT settings.</span></span><br><span class="line">  <span class="comment"># And if true, all config from default NexT `_config.yml` have to be copied into `next.yml`. Use if you know what you are doing.</span></span><br><span class="line">  <span class="comment"># Useful if you want to comment some options from NexT `_config.yml` by `next.yml` without editing default config.</span></span><br><span class="line">  <span class="attr">override:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># ...</span></span><br></pre></td></tr></table></figure><p>这样可以避免更新主题时由于配置不统一导致需要手动处理merge的问题。</p><h2 id="看板娘"><a href="#看板娘" class="headerlink" title="看板娘"></a>看板娘</h2><p>参考</p><blockquote><ol><li><a target="_blank" rel="noopener" href="https://github.com/stevenjoezhang/live2d-widget">live2d-widget</a></li></ol></blockquote><blockquote><ol start="2"><li><a target="_blank" rel="noopener" href="https://www.fghrsh.net/post/123.html">网页添加 Live2D 看板娘</a></li></ol></blockquote><blockquote><ol start="3"><li><a target="_blank" rel="noopener" href="https://imjad.cn/archives/lab/add-dynamic-poster-girl-with-live2d-to-your-blog-01/">给博客添加能动的看板娘</a></li></ol></blockquote><p>增加了部分修改：</p><ol><li><p>去掉了小飞机。<code>// &lt;span class=&quot;fa fa-lg fa-paper-plane&quot;&gt;&lt;/span&gt;</code></p></li><li><p>去掉了宽度过窄就不显示的逻辑。（让手机端默认显示）</p></li></ol><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">@media (max-width: 768px) &#123;</span></span><br><span class="line"><span class="comment">	#waifu &#123;</span></span><br><span class="line"><span class="comment">		display: none;</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// if (screen.width &gt;= 768) &#123;</span></span><br><span class="line">4...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="自建API"><a href="#自建API" class="headerlink" title="自建API"></a>自建API</h2><p>一开始是用的别人的API，但别人API总炸，一炸看板娘就没了。</p><p>于是打算自己建API自己用。我在网页方面真心是菜鸟了，工作不搞这方面的东西，知识暂时全靠瞎折腾获取，所以自建API也要写一节！毕竟自己通过查资料试验测试，搞通了之后还是比较有成就感的。</p><p>服务端需要有几个东西。</p><ol><li>php-fpm php-cgi</li><li>fastcgi</li><li>nginx</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/fghrsh/live2d_api.git</span><br></pre></td></tr></table></figure><p>把API直接clone到了Hexo的souce里，这样就能搭车同步了，这也是为什么需要同步的文件又多又大的原因，内置的方法里，只有 Git 能比较轻松的搞定了。</p><p>服务端</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install php-fpm php-cgi</span><br></pre></td></tr></table></figure><p>然后在nginx里面配置使用<code>FastCGI server</code></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pass PHP scripts to FastCGI server</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attribute">location</span> <span class="regexp">~ \.php$</span> &#123;</span><br><span class="line">    <span class="attribute">include</span> snippets/fastcgi-php.conf;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># With php-fpm (or other unix sockets):</span></span><br><span class="line">    <span class="attribute">fastcgi_pass</span> unix:/var/run/php/php7.2-fpm.sock;</span><br><span class="line">    <span class="comment"># With php-cgi (or other tcp sockets):</span></span><br><span class="line">    <span class="comment"># fastcgi_pass 127.0.0.1:9000;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="增加模型"><a href="#增加模型" class="headerlink" title="增加模型"></a>增加模型</h2><p>读了读大佬的API的代码，逻辑也不是很复杂，而且提供了增加模型的支持，在<a target="_blank" rel="noopener" href="https://mx.paul.ren/page/1/">梦象</a>获取模型后，放到<code>/model/*/</code>里，把<code>model.json</code>重命名为<code>index.json</code>即可，然后修改<code>model_list.json</code>，测试了一下没有对<code>live2d</code>模型动作的依赖。如果有模型大小不合适的，在<code>index.json</code>中修改<code>layout</code>项。</p><h1 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h1><p>服务器本地加载Live2d有些慢，毕竟小水管服务器，还是CDN加速比较稳定而且负载小一些，有时间可以搞一下。</p><p>Live2d的模型在<a target="_blank" rel="noopener" href="https://github.com/Eikanya/Live2d-model">Live2d-model</a>找到了有大佬在收集。</p><p>emm，后来也发现了好多大佬的博客做的非常漂亮，暂时不再深入下去，（前端深坑，好可怕……</p></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://yuanjiuzheng.com/blog/cc00/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/web/avatar-nemo3.jpg"><meta itemprop="name" content="Nemo.yeran"><meta itemprop="description" content="一直折腾一直爽"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Yeran"></span><header class="post-header"><h2 class="post-title" itemprop="name headline"> <a href="/blog/cc00/" class="post-title-link" itemprop="url">【建站测试】文章格式测试</a></h2><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-04-11 21:04:43" itemprop="dateCreated datePublished" datetime="2020-04-11T21:04:43+08:00">2020-04-11</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%BB%BA%E7%AB%99%E6%B5%8B%E8%AF%95/" itemprop="url" rel="index"><span itemprop="name">建站测试</span></a></span></span></div><div class="post-meta"><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>2k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>2 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><h1 id="代码段测试"><a href="#代码段测试" class="headerlink" title="代码段测试"></a>代码段测试</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span>... Tail&gt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(T head, Tail... tail)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  g(head);</span><br><span class="line">  f(tail...);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// clang-format off</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">g</span><span class="params">(T x)</span></span>&#123;<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; x &lt;&lt; <span class="string">&quot; &quot;</span>; &#125;</span><br><span class="line"><span class="comment">// clang-format on</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;testA:&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span> &lt;&lt; <span class="string">&quot;\t&quot;</span>;</span><br><span class="line">  f(<span class="number">1</span>, <span class="number">2.2</span>, <span class="string">&quot;hello&quot;</span>);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;testB:&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span> &lt;&lt; <span class="string">&quot;\t&quot;</span>;</span><br><span class="line">  f(<span class="number">0.2</span>, <span class="number">666</span>, <span class="string">&quot;yuck!&quot;</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="图片测试"><a href="#图片测试" class="headerlink" title="图片测试"></a>图片测试</h1><p><img src="/images/posts/test.jpg" alt="This is an test image"><br><code>\&#123;\%</code> <code>asset_img /images/posts/test.jpg This is an test image \&#125;\%</code></p><h1 id="表格测试"><a href="#表格测试" class="headerlink" title="表格测试"></a>表格测试</h1><table><thead><tr><th>表头A</th><th>表头B</th><th>表头C</th></tr></thead><tbody><tr><td>A</td><td>B</td><td>C</td></tr><tr><td>A</td><td>B</td><td>C</td></tr><tr><td>A</td><td>B</td><td>C</td></tr></tbody></table><h1 id="标签插件"><a href="#标签插件" class="headerlink" title="标签插件"></a>标签插件</h1><h2 id="标签页"><a href="#标签页" class="headerlink" title="标签页"></a>标签页</h2><div class="tabs" id="fourth-unique-name"><ul class="nav-tabs"><li class="tab active"><a href="#fourth-unique-name-1">Solution 1 点我</a></li><li class="tab"><a href="#fourth-unique-name-2">Solution 2 点我</a></li><li class="tab"><a href="#fourth-unique-name-3">Solution 3 点我</a></li></ul><div class="tab-content"><div class="tab-pane active" id="fourth-unique-name-1"><p><strong>This is Tab 1.</strong></p></div><div class="tab-pane" id="fourth-unique-name-2"><p><strong>This is Tab 2.</strong></p></div><div class="tab-pane" id="fourth-unique-name-3"><p><strong>This is Tab 3.</strong></p></div></div></div><h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><hr><p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque hendrerit lacus ut purus iaculis feugiat. Sed nec tempor elit, quis aliquam neque. Curabitur sed diam eget dolor fermentum semper at eu lorem.</p><hr><blockquote><p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque hendrerit lacus ut purus iaculis feugiat. Sed nec tempor elit, quis aliquam neque. Curabitur sed diam eget dolor fermentum semper at eu lorem.</p></blockquote><hr><blockquote><p>Do not just seek happiness for yourself. Seek happiness for all. Through kindness. Through mercy.</p><footer><strong>David Levithan</strong><cite>Wide Awake</cite></footer></blockquote><hr><blockquote><p>NEW: DevDocs now comes with syntax highlighting. <a target="_blank" rel="noopener" href="http://devdocs.io/">http://devdocs.io</a></p><footer><strong>@DevDocs</strong><cite><a target="_blank" rel="noopener" href="https://twitter.com/devdocs/status/356095192085962752">twitter.com/devdocs/status/356095192085962752</a></cite></footer></blockquote><hr><blockquote><p>Every interaction is both precious and an opportunity to delight.</p><footer><strong>Seth Godin</strong><cite><a target="_blank" rel="noopener" href="http://sethgodin.typepad.com/seths_blog/2009/07/welcome-to-island-marketing.html">Welcome to Island Marketing</a></cite></footer></blockquote><hr><h1 id="more"><a href="#more" class="headerlink" title="more"></a>more</h1><p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p><div class="post-button"> <a class="btn" href="/blog/cc00/#more" rel="contents">阅读全文 &raquo;</a></div></div><footer class="post-footer"><div class="post-eof"></div></footer></article></div><script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">沪ICP备 - 20008968号</a> <img src="/images/web/favicon/gov.png" style="display:inline-block"><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=%E5%85%AC%E5%AE%89%E5%A4%87%E6%A1%88%E5%8F%B7%E5%BE%85%E7%A1%AE%E8%AE%A4" rel="noopener" target="_blank">公安备案号待确认</a></div><div class="copyright"> &copy; <span itemprop="copyrightYear">2020</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Nemo.yeran</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span title="站点总字数">54k</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span title="站点阅读时长">49 分钟</span></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="powered-by">基于 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 搭建</div><div class="addthis_inline_share_toolbox"><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e929ada50a7441f" async="async"></script></div></div></footer><script src="/lib/animejs/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/gh/next-theme/pjax@0/pjax.min.js"></script><script src="/lib/jquery/dist/jquery.min.js"></script><script src="/lib/@fancyapps/fancybox/dist/jquery.fancybox.min.js"></script><script src="/lib/lozad/dist/lozad.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '.page-configurations',
    '.main-inner',
    '.post-toc-wrap',
    '.languages',
    '.pjax'
  ],
  analytics: false,
  cacheBust: false,
  scrollRestoration: false,
  scrollTo: !CONFIG.bookmark.enable
});

document.addEventListener('pjax:success', () => {
  pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  const hasTOC = document.querySelector('.post-toc');
  document.querySelector('.sidebar-inner').classList.toggle('sidebar-nav-active', hasTOC);
  document.querySelector(hasTOC ? '.sidebar-nav-toc' : '.sidebar-nav-overview').click();
  NexT.utils.updateSidebarPosition();
});
</script><script data-pjax>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="/js/local-search.js"></script><script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="pjax"></div></body></html>